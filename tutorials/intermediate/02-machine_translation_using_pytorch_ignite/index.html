<!DOCTYPE html><html lang="en-us" dir="ltr"><head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="theme-color" content="#ee4c2c">
<meta name="keywords" content="pytorch,pytorch ignite,ignite,engine,events,handlers,metrics,website">
<link rel="icon" type="image/svg+xml" href="/_images/ignite_logomark.svg">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@pytorch_ignite">
<meta name="twitter:creator" content="@pytorch_ignite">
<meta name="twitter:image" content="https://raw.githubusercontent.com/pytorch/ignite/master/assets/logo/ignite_logo.png">
<meta name="twitter:image:alt" content="PyTorch-Ignite logo">
<meta property="og:type" content="website">
<meta property="og:site_name" content="PyTorch-Ignite">
<meta property="og:image" content="https://raw.githubusercontent.com/pytorch/ignite/master/assets/logo/ignite_logo.png">
<meta property="og:image:alt" content="PyTorch-Ignite logo">
<meta name="description" content="High-level library to help with training and evaluating neural networks in PyTorch flexibly and transparently.">
<meta property="og:description" content="High-level library to help with training and evaluating neural networks in PyTorch flexibly and transparently.">
<meta name="twitter:description" content="High-level library to help with training and evaluating neural networks in PyTorch flexibly and transparently.">
<title>
Machine Translation using PyTorch Ignite
| PyTorch-Ignite</title>
<meta property="og:title" content="  
    Machine Translation using PyTorch Ignite
   | PyTorch-Ignite">
<meta name="twitter:title" content="  
    Machine Translation using PyTorch Ignite
   | PyTorch-Ignite">
<link rel="preload" href="https://rsms.me/inter/inter.css" as="style">
<link rel="stylesheet" href="https://rsms.me/inter/inter.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@docsearch/css@3">
<link rel="stylesheet" href="/_hugo/css/style.3b470591ca1a50dbc1f43747f0bc429f.min.css">
<link rel="stylesheet" href="/_hugo/css/main.9acd436c5609f4c6f7c0a9a9c6536f57.min.css">
<link rel="preconnect" href="https://7EWYE1JCT3-dsn.algolia.net" crossorigin="" data-proofer-ignore="">
<link rel="canonical" href="https://pytorch-ignite.ai/tutorials/intermediate/02-machine_translation_using_pytorch_ignite/">
<script>const saved=localStorage.getItem('ignite-color-scheme');(saved?saved==='dark':window.matchMedia(`(prefers-color-scheme: dark)`).matches)&&(document.documentElement.classList.add('dark'),document.documentElement.dataset.theme='dark')</script>
</head>
<body class="bg-white
font-sans
text-blue-gray-600
antialiased
dark:bg-dark-700 dark:text-warm-gray-200">
<header class="bg-white
border-b
flex
h-$header-height
py-2
px-6
top-0
right-0
left-0
z-10
justify-between
items-center
sticky
<sm:px-4
dark:bg-dark-700
dark:border-b-dark-200">
<div class="flex items-center">
<button class="mr-1 lg:hidden" id="sideBarBtn" aria-label="Toggle Sidebar"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentcolor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"></path></svg>
</button>
<a href="/" class="flex items-center">
<img src="/_images/ignite_logomark.svg" alt="PyTorch-Ignite" width="50" height="50" class="h-40px w-auto" loading="lazy">
<span class="font-semibold">PyTorch-Ignite</span>
</a>
</div>
<div class="flex-grow"></div>
<div class="hidden lg:block">
<nav class="place-content-center place-items-center block lg:flex">
<div class="p-1 relative group lg:p-2">
<button class="dropDownBtn" aria-label="Toggle Dropdown">Docs</button><svg id="chevronRight" xmlns="http://www.w3.org/2000/svg" class="h-5 transition-transform duration-300 transform w-5 rotate-90 inline-block" viewBox="0 0 20 20" fill="currentcolor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414.0z" clip-rule="evenodd"></path></svg>
<ul id="dropDownList" class="bg-white
border
rounded-lg
min-w-50
p-2
right-0
hidden
lg:absolute
dark:bg-dark-700 dark:border-dark-200
lg:group-hover:block">
<li class="children:rounded-lg children:hover:bg-gray-200
dark:children:hover:bg-dark-200">
<a href="/how-to-guides/" target="" rel="" class="p-1 lg:p-2 block whitespace-nowrap hover:text-$c-primary">
Guides
</a>
</li>
<li class="children:rounded-lg children:hover:bg-gray-200
dark:children:hover:bg-dark-200">
<a href="/tutorials/" target="" rel="" class="p-1 lg:p-2 block whitespace-nowrap hover:text-$c-primary text-$c-primary">
Tutorials
</a>
</li>
<li class="children:rounded-lg children:hover:bg-gray-200
dark:children:hover:bg-dark-200">
<a href="/concepts/" target="" rel="" class="p-1 lg:p-2 block whitespace-nowrap hover:text-$c-primary">
Concepts
</a>
</li>
<li class="children:rounded-lg children:hover:bg-gray-200
dark:children:hover:bg-dark-200">
<a href="https://pytorch.org/ignite/engine.html" target="_blank" rel="noopener noreferrer" class="p-1 lg:p-2 block whitespace-nowrap hover:text-$c-primary">
API Reference
</a>
</li>
</ul>
</div>
<a href="/blog/" target="" rel="" class="p-1 lg:p-2 block whitespace-nowrap hover:text-$c-primary">
Blog
</a>
<a href="/ecosystem/" target="" rel="" class="p-1 lg:p-2 block whitespace-nowrap hover:text-$c-primary">
Ecosystem
</a>
<div class="p-1 relative group lg:p-2">
<button class="dropDownBtn" aria-label="Toggle Dropdown">About</button><svg id="chevronRight" xmlns="http://www.w3.org/2000/svg" class="h-5 transition-transform duration-300 transform w-5 rotate-90 inline-block" viewBox="0 0 20 20" fill="currentcolor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414.0z" clip-rule="evenodd"></path></svg>
<ul id="dropDownList" class="bg-white
border
rounded-lg
min-w-50
p-2
right-0
hidden
lg:absolute
dark:bg-dark-700 dark:border-dark-200
lg:group-hover:block">
<li class="children:rounded-lg children:hover:bg-gray-200
dark:children:hover:bg-dark-200">
<a href="/about/community/" target="" rel="" class="p-1 lg:p-2 block whitespace-nowrap hover:text-$c-primary">
Community
</a>
</li>
<li class="children:rounded-lg children:hover:bg-gray-200
dark:children:hover:bg-dark-200">
<a href="/about/contribution-guide/" target="" rel="" class="p-1 lg:p-2 block whitespace-nowrap hover:text-$c-primary">
Contribution Guide
</a>
</li>
<li class="children:rounded-lg children:hover:bg-gray-200
dark:children:hover:bg-dark-200">
<a href="/about/coc/" target="" rel="" class="p-1 lg:p-2 block whitespace-nowrap hover:text-$c-primary">
Code of Conduct
</a>
</li>
<li class="children:rounded-lg children:hover:bg-gray-200
dark:children:hover:bg-dark-200">
<a href="/talks/" target="" rel="" class="p-1 lg:p-2 block whitespace-nowrap hover:text-$c-primary">
Talks
</a>
</li>
<li class="children:rounded-lg children:hover:bg-gray-200
dark:children:hover:bg-dark-200">
<a href="/about/governance/" target="" rel="" class="p-1 lg:p-2 block whitespace-nowrap hover:text-$c-primary">
Governance
</a>
</li>
</ul>
</div>
<a href="https://github.com/pytorch/ignite" target="_blank" rel="noopener noreferrer" class="p-1 lg:p-2 block whitespace-nowrap hover:text-$c-primary">
GitHub
</a>
<a href="https://pytorch-ignite.ai/playground" target="_blank" rel="noopener noreferrer" class="p-1 lg:p-2 block whitespace-nowrap hover:text-$c-primary">
Playground
</a>
<a href="https://code-generator.pytorch-ignite.ai/" target="_blank" rel="noopener noreferrer" class="p-1 lg:p-2 block whitespace-nowrap hover:text-$c-primary">
Code-Generator
</a>
</nav>
</div>
<button aria-label="Toggle Color Scheme" title="Toggle Color Scheme" id="toggleDark" class="mx-2"><svg id="sun" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentcolor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364-.707-.707M6.343 6.343l-.707-.707m12.728.0-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg><svg id="moon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentcolor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003.0 0012 21a9.003 9.003.0 008.354-5.646z"></path></svg>
</button>
<div id="docsearch"></div>
</header>
<div class="grid-cols-[1fr,2fr,1fr] lg:grid xl:grid-cols-[1fr,3fr,1fr]">
<aside class="bg-white
h-$aside-height
top-$header-height
py-3
px-6
transform
transition-transform
z-10
duration-300
fixed
overflow-y-auto
lg:sticky <lg:border-r
<lg:-translate-x-full
<lg:w-75
dark:bg-dark-700
dark:border-dark-200" id="sidebar">
<div class="border-b lg:hidden dark:border-dark-200">
<nav class="place-content-center place-items-center block lg:flex">
<div class="p-1 relative group lg:p-2">
<button class="dropDownBtn" aria-label="Toggle Dropdown">Docs</button><svg id="chevronRight" xmlns="http://www.w3.org/2000/svg" class="h-5 transition-transform duration-300 transform w-5 rotate-90 inline-block" viewBox="0 0 20 20" fill="currentcolor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414.0z" clip-rule="evenodd"></path></svg>
<ul id="dropDownList" class="bg-white
border
rounded-lg
min-w-50
p-2
right-0
hidden
lg:absolute
dark:bg-dark-700 dark:border-dark-200
lg:group-hover:block">
<li class="children:rounded-lg children:hover:bg-gray-200
dark:children:hover:bg-dark-200">
<a href="/how-to-guides/" target="" rel="" class="p-1 lg:p-2 block whitespace-nowrap hover:text-$c-primary">
Guides
</a>
</li>
<li class="children:rounded-lg children:hover:bg-gray-200
dark:children:hover:bg-dark-200">
<a href="/tutorials/" target="" rel="" class="p-1 lg:p-2 block whitespace-nowrap hover:text-$c-primary text-$c-primary">
Tutorials
</a>
</li>
<li class="children:rounded-lg children:hover:bg-gray-200
dark:children:hover:bg-dark-200">
<a href="/concepts/" target="" rel="" class="p-1 lg:p-2 block whitespace-nowrap hover:text-$c-primary">
Concepts
</a>
</li>
<li class="children:rounded-lg children:hover:bg-gray-200
dark:children:hover:bg-dark-200">
<a href="https://pytorch.org/ignite/engine.html" target="_blank" rel="noopener noreferrer" class="p-1 lg:p-2 block whitespace-nowrap hover:text-$c-primary">
API Reference
</a>
</li>
</ul>
</div>
<a href="/blog/" target="" rel="" class="p-1 lg:p-2 block whitespace-nowrap hover:text-$c-primary">
Blog
</a>
<a href="/ecosystem/" target="" rel="" class="p-1 lg:p-2 block whitespace-nowrap hover:text-$c-primary">
Ecosystem
</a>
<div class="p-1 relative group lg:p-2">
<button class="dropDownBtn" aria-label="Toggle Dropdown">About</button><svg id="chevronRight" xmlns="http://www.w3.org/2000/svg" class="h-5 transition-transform duration-300 transform w-5 rotate-90 inline-block" viewBox="0 0 20 20" fill="currentcolor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414.0z" clip-rule="evenodd"></path></svg>
<ul id="dropDownList" class="bg-white
border
rounded-lg
min-w-50
p-2
right-0
hidden
lg:absolute
dark:bg-dark-700 dark:border-dark-200
lg:group-hover:block">
<li class="children:rounded-lg children:hover:bg-gray-200
dark:children:hover:bg-dark-200">
<a href="/about/community/" target="" rel="" class="p-1 lg:p-2 block whitespace-nowrap hover:text-$c-primary">
Community
</a>
</li>
<li class="children:rounded-lg children:hover:bg-gray-200
dark:children:hover:bg-dark-200">
<a href="/about/contribution-guide/" target="" rel="" class="p-1 lg:p-2 block whitespace-nowrap hover:text-$c-primary">
Contribution Guide
</a>
</li>
<li class="children:rounded-lg children:hover:bg-gray-200
dark:children:hover:bg-dark-200">
<a href="/about/coc/" target="" rel="" class="p-1 lg:p-2 block whitespace-nowrap hover:text-$c-primary">
Code of Conduct
</a>
</li>
<li class="children:rounded-lg children:hover:bg-gray-200
dark:children:hover:bg-dark-200">
<a href="/talks/" target="" rel="" class="p-1 lg:p-2 block whitespace-nowrap hover:text-$c-primary">
Talks
</a>
</li>
<li class="children:rounded-lg children:hover:bg-gray-200
dark:children:hover:bg-dark-200">
<a href="/about/governance/" target="" rel="" class="p-1 lg:p-2 block whitespace-nowrap hover:text-$c-primary">
Governance
</a>
</li>
</ul>
</div>
<a href="https://github.com/pytorch/ignite" target="_blank" rel="noopener noreferrer" class="p-1 lg:p-2 block whitespace-nowrap hover:text-$c-primary">
GitHub
</a>
<a href="https://pytorch-ignite.ai/playground" target="_blank" rel="noopener noreferrer" class="p-1 lg:p-2 block whitespace-nowrap hover:text-$c-primary">
Playground
</a>
<a href="https://code-generator.pytorch-ignite.ai/" target="_blank" rel="noopener noreferrer" class="p-1 lg:p-2 block whitespace-nowrap hover:text-$c-primary">
Code-Generator
</a>
</nav></div>
<nav class="py-3 px-1">
<h5 class="font-semibold
py-1
uppercase
active">
Tutorials
</h5>
<ul class="px-2 pb-4">
<li class="py-1">
<a href="/tutorials/beginner/01-getting-started/" class="hover:text-$c-primary py-1">Getting Started</a>
</li>
<li class="py-1">
<a href="/tutorials/beginner/02-transformers-text-classification/" class="hover:text-$c-primary py-1">Transformers for Text Classification with IMDb Reviews</a>
</li>
<li class="py-1">
<a href="/tutorials/intermediate/01-cifar10-distributed/" class="hover:text-$c-primary py-1">Distributed Training on CPUs, GPUs or TPUs</a>
</li>
<li class="py-1">
<a href="/tutorials/intermediate/02-machine_translation_using_pytorch_ignite/" class="text-$c-primary hover:text-$c-primary py-1">Machine Translation using PyTorch Ignite</a>
<div class="text-sm px-2 lg:hidden"><nav id="TableOfContents">
<ul>
<li><a href="#required-dependencies">Required Dependencies</a>
<ul>
<li><a href="#for-tpus">For TPUs</a></li>
</ul>
</li>
<li><a href="#common-configuration">Common Configuration</a></li>
<li><a href="#basic-setup">Basic Setup</a>
<ul>
<li><a href="#imports">Imports</a></li>
<li><a href="#preparing-data">Preparing data</a></li>
<li><a href="#tokenizer">Tokenizer</a></li>
</ul>
</li>
<li><a href="#dataset-class">Dataset Class</a></li>
<li><a href="#trainer">Trainer</a>
<ul>
<li></li>
</ul>
</li>
<li><a href="#evaluator">Evaluator</a></li>
<li><a href="#initializing-functions">Initializing Functions</a></li>
<li><a href="#logging-handlers">Logging Handlers</a></li>
<li><a href="#begin-training">Begin Training</a></li>
<li><a href="#running">Running</a></li>
</ul>
</nav></div>
</li>
<li class="py-1">
<a href="/tutorials/intermediate/03-reinforcement-learning/" class="hover:text-$c-primary py-1">Reinforcement Learning with Ignite</a>
</li>
<li class="py-1">
<a href="/tutorials/advanced/01-collective-communication/" class="hover:text-$c-primary py-1">Collective Communication with Ignite</a>
</li>
</ul>
<h5 class="font-semibold
py-1
uppercase">
How-to-Guides
</h5>
<ul class="px-2 pb-4">
<li class="py-1">
<a href="/how-to-guides/01-installation/" class="hover:text-$c-primary py-1">How to install PyTorch-Ignite</a>
</li>
<li class="py-1">
<a href="/how-to-guides/02-convert-pytorch-to-ignite/" class="hover:text-$c-primary py-1">How to convert pure PyTorch code to Ignite</a>
</li>
<li class="py-1">
<a href="/how-to-guides/03-time-profiling/" class="hover:text-$c-primary py-1">How to do time profiling</a>
</li>
<li class="py-1">
<a href="/how-to-guides/04-fastai-lr-finder/" class="hover:text-$c-primary py-1">How to use FastaiLRFinder with Ignite</a>
</li>
<li class="py-1">
<a href="/how-to-guides/05-gradient-accumulation/" class="hover:text-$c-primary py-1">How to effectively increase batch size on limited compute</a>
</li>
<li class="py-1">
<a href="/how-to-guides/06-data-iterator/" class="hover:text-$c-primary py-1">How to work with data iterators</a>
</li>
<li class="py-1">
<a href="/how-to-guides/07-cross-validation/" class="hover:text-$c-primary py-1">How to do Cross Validation in Ignite</a>
</li>
<li class="py-1">
<a href="/how-to-guides/08-custom-events/" class="hover:text-$c-primary py-1">How to create Custom Events based on Forward or Backward Pass</a>
</li>
<li class="py-1">
<a href="/how-to-guides/09-switch-data-training/" class="hover:text-$c-primary py-1">How to switch data provider during training</a>
</li>
<li class="py-1">
<a href="/how-to-guides/10-loggers/" class="hover:text-$c-primary py-1">How to use Loggers</a>
</li>
<li class="py-1">
<a href="/how-to-guides/11-load-checkpoint/" class="hover:text-$c-primary py-1">How to load checkpoint and resume training</a>
</li>
</ul>
</nav>
</aside>
<main class="min-w-0 py-6 px-6">
<div class="relative prose prose-red">
<div class="flex flex-wrap pb-2 justify-center">
<a class="flex py-1 px-2 items-center" href="https://colab.research.google.com/github/pytorch-ignite/pytorch-ignite.ai/blob/gh-pages/tutorials/intermediate/02-Machine_Translation_using_PyTorch_Ignite.ipynb" target="_blank" rel="noopener noreferrer"><svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" width="32" height="32" viewBox="0 0 24 24"><path d="M16.941 4.976a7.033 7.033.0 00-4.93 2.064 7.033 7.033.0 00-.124 9.807l2.395-2.395a3.646 3.646.0 015.15-5.148l2.397-2.399a7.033 7.033.0 00-4.888-1.93zm-9.871.01A7.033 7.033.0 002.182 6.917l2.391 2.391a3.643 3.643.0 015.023.127l1.734-2.973-.1-.08A7.033 7.033.0 007.07 4.986zm15.01 2.172-2.39 2.39a3.646 3.646.0 01-5.15 5.15l-2.406 2.407a7.036 7.036.0 009.945-9.947zm-20.148.01a7.033 7.033.0 00-.002 9.681l2.397-2.397A3.643 3.643.0 014.323 9.56zm7.664 7.423a3.635 3.635.0 01-5.017.113L2.182 17.1a7.029 7.029.0 009.007.546l.137-.112z" fill="currentcolor"></path></svg>
<span class="ml-1">Run in Google Colab</span>
</a>
<a class="flex py-1 px-2 items-center" href="/tutorials/intermediate/02-Machine_Translation_using_PyTorch_Ignite.ipynb" target="_blank" rel="noopener noreferrer" download="02-Machine_Translation_using_PyTorch_Ignite.ipynb"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentcolor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4-4 4m0 0-4-4m4 4V4"></path></svg>
<span class="ml-1">Download as Jupyter Notebook</span>
</a>
<a class="flex py-1 px-2 items-center" href="https://github.com/pytorch-ignite/pytorch-ignite.ai/blob/gh-pages/tutorials/intermediate/02-Machine_Translation_using_PyTorch_Ignite.ipynb" target="_blank" rel="noopener noreferrer"><svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" width="32" height="32" viewBox="0 0 24 24"><path d="M12 2A10 10 0 002 12c0 4.42 2.87 8.17 6.84 9.5.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34-.46-1.16-1.11-1.47-1.11-1.47-.91-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.87 1.52 2.34 1.07 2.91.83.09-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.92.0-1.11.38-2 1.03-2.71-.1-.25-.45-1.29.1-2.64.0.0.84-.27 2.75 1.02.79-.22 1.65-.33 2.5-.33s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02.55 1.35.2 2.39.1 2.64.65.71 1.03 1.6 1.03 2.71.0 3.82-2.34 4.66-4.57 4.91.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0012 2z" fill="currentcolor"></path></svg>
<span class="ml-1">View on GitHub</span>
</a>
</div>
<h1 id="machine-translation-using-pytorch-ignite">
<a href="#machine-translation-using-pytorch-ignite" class="header-anchor">
Machine Translation using PyTorch Ignite
</a>
</h1><p>This tutorial is a brief introduction on how you can train a machine translation model (or any other seq2seq model) using PyTorch Ignite.
This notebook uses Models, Dataset and Tokenizers from Huggingface, hence they can be easily replaced by other models from the 🤗 Hub.</p>
<h2 id="required-dependencies">
<a href="#required-dependencies" class="header-anchor">
Required Dependencies
</a>
</h2><div class="highlight"><pre class="shiki one-dark-pro" style="background-color: #282c34"><code><span class="line"><span style="color: #56B6C2">%%</span><span style="color: #ABB2BF">capture</span></span>
<span class="line"><span style="color: #FFFFFF">!</span><span style="color: #ABB2BF">pip install pytorch</span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">ignite</span></span>
<span class="line"><span style="color: #FFFFFF">!</span><span style="color: #ABB2BF">pip install transformers</span></span>
<span class="line"><span style="color: #FFFFFF">!</span><span style="color: #ABB2BF">pip install datasets</span></span>
<span class="line"><span style="color: #FFFFFF">!</span><span style="color: #ABB2BF">pip install sentencepiece</span></span>
<span class="line"></span></code></pre><button class="absolute top-1 right-1 copyBtn">
      <svg id="copyIt" class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" width="32" height="32" preserveAspectRatio="xMidYMid meet" viewBox="0 0 32 32"><path d="M28 10v18H10V10h18m0-2H10a2 2 0 0 0-2 2v18a2 2 0 0 0 2 2h18a2 2 0 0 0 2-2V10a2 2 0 0 0-2-2z" fill="#fff"></path><path d="M4 18H2V4a2 2 0 0 1 2-2h14v2H4z" fill="#fff"></path></svg>
      <svg id="copyDone" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="#0f0">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      </button></div>
<h3 id="for-tpus">
<a href="#for-tpus" class="header-anchor">
For TPUs
</a>
</h3><div class="highlight"><pre class="shiki one-dark-pro" style="background-color: #282c34"><code><span class="line"><span style="color: #7F848E; font-style: italic"># VERSION = !curl -s https://api.github.com/repos/pytorch/xla/releases/latest | grep -Po '"tag_name": "v\K.*?(?=")'</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># VERSION = VERSION[0].rstrip('.0') # remove trailing zero</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># !pip install cloud-tpu-client==0.10 https://storage.googleapis.com/tpu-pytorch/wheels/torch_xla-{VERSION}-cp37-cp37m-linux_x86_64.whl</span></span>
<span class="line"></span></code></pre><button class="absolute top-1 right-1 copyBtn">
      <svg id="copyIt" class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" width="32" height="32" preserveAspectRatio="xMidYMid meet" viewBox="0 0 32 32"><path d="M28 10v18H10V10h18m0-2H10a2 2 0 0 0-2 2v18a2 2 0 0 0 2 2h18a2 2 0 0 0 2-2V10a2 2 0 0 0-2-2z" fill="#fff"></path><path d="M4 18H2V4a2 2 0 0 1 2-2h14v2H4z" fill="#fff"></path></svg>
      <svg id="copyDone" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="#0f0">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      </button></div>
<h2 id="common-configuration">
<a href="#common-configuration" class="header-anchor">
Common Configuration
</a>
</h2><p>We maintain a config dictionary which can be extended or changed to store parameters required during training. We can refer back to this code when we will use these parameters later.</p>
<p>In this example we are using <code>t5-small</code>, which has 60M parameters. The way t5 models work is they take an input with a task-specific prefix. This prefix (like “Translate English to German”) will let our model know which task it needs to perform. For more details refer to the original paper
<a href="https://arxiv.org/abs/1910.10683" target="_blank" rel="noopener noreferrer">here</a>.</p>
<p>Here we train on less number of iterations per step and on a limited dataset, this can be modified using the <code>train_dataset_length</code> and <code>epoch_length</code> config.</p>
<div class="highlight"><pre class="shiki one-dark-pro" style="background-color: #282c34"><code><span class="line"><span style="color: #ABB2BF">config </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #98C379">"seed"</span><span style="color: #ABB2BF">: </span><span style="color: #D19A66">216</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #98C379">"with_amp"</span><span style="color: #ABB2BF">: </span><span style="color: #D19A66">False</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #98C379">"num_epochs"</span><span style="color: #ABB2BF">: </span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #98C379">"batch_size"</span><span style="color: #ABB2BF">: </span><span style="color: #D19A66">32</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #98C379">"output_path_"</span><span style="color: #ABB2BF">: </span><span style="color: #98C379">"/content"</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #98C379">"model_name"</span><span style="color: #ABB2BF">: </span><span style="color: #98C379">"t5-small"</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #98C379">"tokenizer_name"</span><span style="color: #ABB2BF">: </span><span style="color: #98C379">"t5-small"</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #98C379">"freeze_encoder"</span><span style="color: #ABB2BF">: </span><span style="color: #D19A66">False</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #98C379">"num_workers"</span><span style="color: #ABB2BF">: </span><span style="color: #D19A66">4</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #98C379">"weight_decay"</span><span style="color: #ABB2BF">: </span><span style="color: #D19A66">0.01</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #98C379">"learning_rate"</span><span style="color: #ABB2BF">: </span><span style="color: #D19A66">1e-4</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #98C379">"accumulation_steps"</span><span style="color: #ABB2BF">: </span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #98C379">"epoch_length"</span><span style="color: #ABB2BF">: </span><span style="color: #D19A66">500</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #98C379">"print_output_every"</span><span style="color: #ABB2BF">: </span><span style="color: #D19A66">50</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">dataset_configs </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #98C379">"source_language"</span><span style="color: #ABB2BF">:</span><span style="color: #98C379">"English"</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #98C379">"source_text_id"</span><span style="color: #ABB2BF">:</span><span style="color: #98C379">"en"</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #98C379">"target_language"</span><span style="color: #ABB2BF">:</span><span style="color: #98C379">"German"</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #98C379">"target_text_id"</span><span style="color: #ABB2BF">:</span><span style="color: #98C379">"de"</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #98C379">"max_length"</span><span style="color: #ABB2BF">: </span><span style="color: #D19A66">80</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #98C379">"train_dataset_length"</span><span style="color: #ABB2BF">: </span><span style="color: #56B6C2">-</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #98C379">"validation_dataset_length"</span><span style="color: #ABB2BF">: </span><span style="color: #D19A66">100</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #98C379">"train_test_split"</span><span style="color: #ABB2BF">: </span><span style="color: #D19A66">0.3</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span>
<span class="line"></span></code></pre><button class="absolute top-1 right-1 copyBtn">
      <svg id="copyIt" class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" width="32" height="32" preserveAspectRatio="xMidYMid meet" viewBox="0 0 32 32"><path d="M28 10v18H10V10h18m0-2H10a2 2 0 0 0-2 2v18a2 2 0 0 0 2 2h18a2 2 0 0 0 2-2V10a2 2 0 0 0-2-2z" fill="#fff"></path><path d="M4 18H2V4a2 2 0 0 1 2-2h14v2H4z" fill="#fff"></path></svg>
      <svg id="copyDone" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="#0f0">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      </button></div>
<h2 id="basic-setup">
<a href="#basic-setup" class="header-anchor">
Basic Setup
</a>
</h2>
<h3 id="imports">
<a href="#imports" class="header-anchor">
Imports
</a>
</h3><div class="highlight"><pre class="shiki one-dark-pro" style="background-color: #282c34"><code><span class="line"><span style="color: #C678DD; font-style: italic">import</span><span style="color: #ABB2BF"> warnings</span></span>
<span class="line"><span style="color: #C678DD; font-style: italic">from</span><span style="color: #ABB2BF"> datetime </span><span style="color: #C678DD; font-style: italic">import</span><span style="color: #ABB2BF"> datetime</span></span>
<span class="line"><span style="color: #C678DD; font-style: italic">from</span><span style="color: #ABB2BF"> pathlib </span><span style="color: #C678DD; font-style: italic">import</span><span style="color: #ABB2BF"> Path</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD; font-style: italic">import</span><span style="color: #ABB2BF"> numpy </span><span style="color: #C678DD; font-style: italic">as</span><span style="color: #ABB2BF"> np</span></span>
<span class="line"><span style="color: #C678DD; font-style: italic">import</span><span style="color: #ABB2BF"> torch</span></span>
<span class="line"><span style="color: #C678DD; font-style: italic">import</span><span style="color: #ABB2BF"> torch.nn </span><span style="color: #C678DD; font-style: italic">as</span><span style="color: #ABB2BF"> nn</span></span>
<span class="line"><span style="color: #C678DD; font-style: italic">import</span><span style="color: #ABB2BF"> torch.optim </span><span style="color: #C678DD; font-style: italic">as</span><span style="color: #ABB2BF"> optim</span></span>
<span class="line"><span style="color: #C678DD; font-style: italic">from</span><span style="color: #ABB2BF"> torch.cuda.amp </span><span style="color: #C678DD; font-style: italic">import</span><span style="color: #ABB2BF"> GradScaler, autocast</span></span>
<span class="line"><span style="color: #C678DD; font-style: italic">from</span><span style="color: #ABB2BF"> torch.utils.data </span><span style="color: #C678DD; font-style: italic">import</span><span style="color: #ABB2BF"> random_split</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD; font-style: italic">import</span><span style="color: #ABB2BF"> ignite</span></span>
<span class="line"><span style="color: #C678DD; font-style: italic">import</span><span style="color: #ABB2BF"> ignite.distributed </span><span style="color: #C678DD; font-style: italic">as</span><span style="color: #ABB2BF"> idist</span></span>
<span class="line"><span style="color: #C678DD; font-style: italic">from</span><span style="color: #ABB2BF"> ignite.contrib.engines </span><span style="color: #C678DD; font-style: italic">import</span><span style="color: #ABB2BF"> common</span></span>
<span class="line"><span style="color: #C678DD; font-style: italic">from</span><span style="color: #ABB2BF"> ignite.engine </span><span style="color: #C678DD; font-style: italic">import</span><span style="color: #ABB2BF"> Engine, Events</span></span>
<span class="line"><span style="color: #C678DD; font-style: italic">from</span><span style="color: #ABB2BF"> ignite.handlers </span><span style="color: #C678DD; font-style: italic">import</span><span style="color: #ABB2BF"> Checkpoint, global_step_from_engine</span></span>
<span class="line"><span style="color: #C678DD; font-style: italic">from</span><span style="color: #ABB2BF"> ignite.metrics </span><span style="color: #C678DD; font-style: italic">import</span><span style="color: #ABB2BF"> Bleu</span></span>
<span class="line"><span style="color: #C678DD; font-style: italic">from</span><span style="color: #ABB2BF"> ignite.utils </span><span style="color: #C678DD; font-style: italic">import</span><span style="color: #ABB2BF"> manual_seed, setup_logger</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD; font-style: italic">from</span><span style="color: #ABB2BF"> datasets </span><span style="color: #C678DD; font-style: italic">import</span><span style="color: #ABB2BF"> load_dataset</span></span>
<span class="line"><span style="color: #C678DD; font-style: italic">from</span><span style="color: #ABB2BF"> transformers </span><span style="color: #C678DD; font-style: italic">import</span><span style="color: #ABB2BF"> T5ForConditionalGeneration, AutoTokenizer</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">warnings.</span><span style="color: #61AFEF">filterwarnings</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"ignore"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"></span></code></pre><button class="absolute top-1 right-1 copyBtn">
      <svg id="copyIt" class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" width="32" height="32" preserveAspectRatio="xMidYMid meet" viewBox="0 0 32 32"><path d="M28 10v18H10V10h18m0-2H10a2 2 0 0 0-2 2v18a2 2 0 0 0 2 2h18a2 2 0 0 0 2-2V10a2 2 0 0 0-2-2z" fill="#fff"></path><path d="M4 18H2V4a2 2 0 0 1 2-2h14v2H4z" fill="#fff"></path></svg>
      <svg id="copyDone" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="#0f0">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      </button></div>
<h3 id="preparing-data">
<a href="#preparing-data" class="header-anchor">
Preparing data
</a>
</h3><p>We will be using the
<a href="https://huggingface.co/datasets/news_commentary/blob/main/news_commentary.py" target="_blank" rel="noopener noreferrer">new_commentary</a> data (English - German) from the 🤗 Hub for this example.</p>
<div class="highlight"><pre class="shiki one-dark-pro" style="background-color: #282c34"><code><span class="line"><span style="color: #C678DD; font-style: italic">from</span><span style="color: #ABB2BF"> datasets </span><span style="color: #C678DD; font-style: italic">import</span><span style="color: #ABB2BF"> load_dataset</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">dataset </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">load_dataset</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"news_commentary"</span><span style="color: #ABB2BF">, </span><span style="color: #98C379">"de-en"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">dataset </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> dataset.</span><span style="color: #61AFEF">shuffle</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75; font-style: italic">seed</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF">config[</span><span style="color: #98C379">"seed"</span><span style="color: #ABB2BF">])</span></span>
<span class="line"></span></code></pre><button class="absolute top-1 right-1 copyBtn">
      <svg id="copyIt" class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" width="32" height="32" preserveAspectRatio="xMidYMid meet" viewBox="0 0 32 32"><path d="M28 10v18H10V10h18m0-2H10a2 2 0 0 0-2 2v18a2 2 0 0 0 2 2h18a2 2 0 0 0 2-2V10a2 2 0 0 0-2-2z" fill="#fff"></path><path d="M4 18H2V4a2 2 0 0 1 2-2h14v2H4z" fill="#fff"></path></svg>
      <svg id="copyDone" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="#0f0">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      </button></div><pre><code>Reusing dataset news_commentary (/root/.cache/huggingface/datasets/news_commentary/de-en/11.0.0/cfab724ce975dc2da51cdae45302389860badc88b74db8570d561ced6004f8b4)



  0%|          | 0/1 [00:00&lt;?, ?it/s]


Loading cached shuffled indices for dataset at /root/.cache/huggingface/datasets/news_commentary/de-en/11.0.0/cfab724ce975dc2da51cdae45302389860badc88b74db8570d561ced6004f8b4/cache-199f0b60779b6122.arrow
</code></pre>
<div class="highlight"><pre class="shiki one-dark-pro" style="background-color: #282c34"><code><span class="line"><span style="color: #ABB2BF">dataset </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> dataset[</span><span style="color: #98C379">"train"</span><span style="color: #ABB2BF">]</span></span>
<span class="line"><span style="color: #ABB2BF">dataset </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> dataset.</span><span style="color: #61AFEF">train_test_split</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75; font-style: italic">test_size</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF">dataset_configs[</span><span style="color: #98C379">"train_test_split"</span><span style="color: #ABB2BF">])</span></span>
<span class="line"><span style="color: #ABB2BF">train_dataset, validation_dataset </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> dataset[</span><span style="color: #98C379">"train"</span><span style="color: #ABB2BF">], dataset[</span><span style="color: #98C379">"test"</span><span style="color: #ABB2BF">]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #56B6C2">print</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"Lengths"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #56B6C2">print</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"</span><span style="color: #56B6C2">\t</span><span style="color: #98C379"> Train Set - </span><span style="color: #D19A66">{}</span><span style="color: #98C379">"</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">format</span><span style="color: #ABB2BF">(</span><span style="color: #56B6C2">len</span><span style="color: #ABB2BF">(train_dataset)))</span></span>
<span class="line"><span style="color: #56B6C2">print</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"</span><span style="color: #56B6C2">\t</span><span style="color: #98C379"> Val Set - </span><span style="color: #D19A66">{}</span><span style="color: #98C379">"</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">format</span><span style="color: #ABB2BF">(</span><span style="color: #56B6C2">len</span><span style="color: #ABB2BF">(validation_dataset)))</span></span>
<span class="line"></span></code></pre><button class="absolute top-1 right-1 copyBtn">
      <svg id="copyIt" class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" width="32" height="32" preserveAspectRatio="xMidYMid meet" viewBox="0 0 32 32"><path d="M28 10v18H10V10h18m0-2H10a2 2 0 0 0-2 2v18a2 2 0 0 0 2 2h18a2 2 0 0 0 2-2V10a2 2 0 0 0-2-2z" fill="#fff"></path><path d="M4 18H2V4a2 2 0 0 1 2-2h14v2H4z" fill="#fff"></path></svg>
      <svg id="copyDone" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="#0f0">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      </button></div><pre><code>Loading cached split indices for dataset at /root/.cache/huggingface/datasets/news_commentary/de-en/11.0.0/cfab724ce975dc2da51cdae45302389860badc88b74db8570d561ced6004f8b4/cache-23d286abe396b3d4.arrow and /root/.cache/huggingface/datasets/news_commentary/de-en/11.0.0/cfab724ce975dc2da51cdae45302389860badc88b74db8570d561ced6004f8b4/cache-387687cf22f2e607.arrow


Lengths
     Train Set - 156207
     Val Set - 66946
</code></pre>
<p>Having a look at a dataset sample.</p>
<div class="highlight"><pre class="shiki one-dark-pro" style="background-color: #282c34"><code><span class="line"><span style="color: #56B6C2">print</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"Example of a Datapoint </span><span style="color: #56B6C2">\n</span><span style="color: #98C379">"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #56B6C2">print</span><span style="color: #ABB2BF">(train_dataset[</span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">], </span><span style="color: #98C379">"</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"></span></code></pre><button class="absolute top-1 right-1 copyBtn">
      <svg id="copyIt" class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" width="32" height="32" preserveAspectRatio="xMidYMid meet" viewBox="0 0 32 32"><path d="M28 10v18H10V10h18m0-2H10a2 2 0 0 0-2 2v18a2 2 0 0 0 2 2h18a2 2 0 0 0 2-2V10a2 2 0 0 0-2-2z" fill="#fff"></path><path d="M4 18H2V4a2 2 0 0 1 2-2h14v2H4z" fill="#fff"></path></svg>
      <svg id="copyDone" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="#0f0">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      </button></div><pre><code>Example of a Datapoint 

{'id': '123598', 'translation': {'de': 'Nachrichtenberichte und „Analysen“ der staatlich kontrollierten Sender in Russland und Georgien, die ein negatives Image „des Feindes“ zeichnen, dienen lediglich dazu, die Kluft zwischen den ethnischen Gruppen noch zu vertiefen.', 'en': 'News reports and “analysis” by state-controlled channels in both Russia and Georgia that promote negative images of “the enemy” serve only to widen the gap between ethnic groups.'}} 
</code></pre>
<h3 id="tokenizer">
<a href="#tokenizer" class="header-anchor">
Tokenizer
</a>
</h3><p>The tokenizer needs to be defined to convert the input from strings to token ids. The Machine Translation tokenizers need additional parameters about the source language and target language, refer
<a href="https://huggingface.co/transformers/model_doc/mbart.html#transformers.MBartTokenizer" target="_blank" rel="noopener noreferrer">here</a> for more info.</p>
<div class="highlight"><pre class="shiki one-dark-pro" style="background-color: #282c34"><code><span class="line"><span style="color: #ABB2BF">tokenizer </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> AutoTokenizer.</span><span style="color: #61AFEF">from_pretrained</span><span style="color: #ABB2BF">(config[</span><span style="color: #98C379">"tokenizer_name"</span><span style="color: #ABB2BF">])</span></span>
<span class="line"></span></code></pre><button class="absolute top-1 right-1 copyBtn">
      <svg id="copyIt" class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" width="32" height="32" preserveAspectRatio="xMidYMid meet" viewBox="0 0 32 32"><path d="M28 10v18H10V10h18m0-2H10a2 2 0 0 0-2 2v18a2 2 0 0 0 2 2h18a2 2 0 0 0 2-2V10a2 2 0 0 0-2-2z" fill="#fff"></path><path d="M4 18H2V4a2 2 0 0 1 2-2h14v2H4z" fill="#fff"></path></svg>
      <svg id="copyDone" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="#0f0">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      </button></div>
<h2 id="dataset-class">
<a href="#dataset-class" class="header-anchor">
Dataset Class
</a>
</h2><p>Tokenizes the data and returns a dictionary with inputs and targets.</p>
<p>If you want to train on a subset of the data - modify the <code>train_dataset_length</code> and <code>validation_dataset_length</code> in the dataset configs. Keep them as -1 for taking the whole length.</p>
<div class="highlight"><pre class="shiki one-dark-pro" style="background-color: #282c34"><code><span class="line"><span style="color: #C678DD">class</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">TransformerDataset</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">torch</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">utils</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">data</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Dataset</span><span style="color: #ABB2BF">):</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">def</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">__init__</span><span style="color: #ABB2BF">(</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E5C07B; font-style: italic">self</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66; font-style: italic">data</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66; font-style: italic">src_text_id</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66; font-style: italic">tgt_text_id</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66; font-style: italic">tokenizer</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66; font-style: italic">max_length</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66; font-style: italic">length_dataset</span></span>
<span class="line"><span style="color: #ABB2BF">    ):</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E5C07B">self</span><span style="color: #ABB2BF">.data </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> data</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E5C07B">self</span><span style="color: #ABB2BF">.src_text_id </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> src_text_id</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E5C07B">self</span><span style="color: #ABB2BF">.tgt_text_id </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> tgt_text_id</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E5C07B">self</span><span style="color: #ABB2BF">.tokenizer </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> tokenizer</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E5C07B">self</span><span style="color: #ABB2BF">.max_length </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> max_length</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E5C07B">self</span><span style="color: #ABB2BF">.length_dataset </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> length_dataset </span><span style="color: #C678DD; font-style: italic">if</span><span style="color: #ABB2BF"> length_dataset </span><span style="color: #56B6C2">!=</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD; font-style: italic">else</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">len</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">self</span><span style="color: #ABB2BF">.data)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">def</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">__getitem__</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B; font-style: italic">self</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66; font-style: italic">idx</span><span style="color: #ABB2BF">):</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #7F848E; font-style: italic"># t5 models require a prefix describing the task</span></span>
<span class="line"><span style="color: #ABB2BF">        task_prefix </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">"translate </span><span style="color: #D19A66">{}</span><span style="color: #98C379"> to </span><span style="color: #D19A66">{}</span><span style="color: #98C379">: "</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">format</span><span style="color: #ABB2BF">(dataset_configs[</span><span style="color: #98C379">"source_language"</span><span style="color: #ABB2BF">], dataset_configs[</span><span style="color: #98C379">"target_language"</span><span style="color: #ABB2BF">])</span></span>
<span class="line"><span style="color: #ABB2BF">        src_text </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> [task_prefix </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">str</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">self</span><span style="color: #ABB2BF">.data[idx][</span><span style="color: #98C379">"translation"</span><span style="color: #ABB2BF">][</span><span style="color: #E5C07B">self</span><span style="color: #ABB2BF">.src_text_id])]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">        tgt_text </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> [</span><span style="color: #56B6C2">str</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">self</span><span style="color: #ABB2BF">.data[idx][</span><span style="color: #98C379">"translation"</span><span style="color: #ABB2BF">][</span><span style="color: #E5C07B">self</span><span style="color: #ABB2BF">.tgt_text_id])]</span></span>
<span class="line"><span style="color: #ABB2BF">        input_txt_tokenized </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">self</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">tokenizer</span><span style="color: #ABB2BF">(</span></span>
<span class="line"><span style="color: #ABB2BF">            src_text, </span><span style="color: #E06C75; font-style: italic">max_length</span><span style="color: #56B6C2">=</span><span style="color: #E5C07B">self</span><span style="color: #ABB2BF">.max_length, </span><span style="color: #E06C75; font-style: italic">padding</span><span style="color: #56B6C2">=</span><span style="color: #98C379">"max_length"</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75; font-style: italic">truncation</span><span style="color: #56B6C2">=</span><span style="color: #D19A66">True</span></span>
<span class="line"><span style="color: #ABB2BF">        )</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #C678DD; font-style: italic">with</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">self</span><span style="color: #ABB2BF">.tokenizer.</span><span style="color: #61AFEF">as_target_tokenizer</span><span style="color: #ABB2BF">():</span></span>
<span class="line"><span style="color: #ABB2BF">            tgt_text_tokenized </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">self</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">tokenizer</span><span style="color: #ABB2BF">(</span></span>
<span class="line"><span style="color: #ABB2BF">                tgt_text,</span></span>
<span class="line"><span style="color: #ABB2BF">                </span><span style="color: #E06C75; font-style: italic">max_length</span><span style="color: #56B6C2">=</span><span style="color: #E5C07B">self</span><span style="color: #ABB2BF">.max_length,</span></span>
<span class="line"><span style="color: #ABB2BF">                </span><span style="color: #E06C75; font-style: italic">padding</span><span style="color: #56B6C2">=</span><span style="color: #98C379">"max_length"</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">                </span><span style="color: #E06C75; font-style: italic">truncation</span><span style="color: #56B6C2">=</span><span style="color: #D19A66">True</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">            )</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #7F848E; font-style: italic"># The pad token in target is replaced with -100 so that it doesn't get added to loss.</span></span>
<span class="line"><span style="color: #ABB2BF">        tgt_text_tokenized </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> [</span></span>
<span class="line"><span style="color: #ABB2BF">            [(l </span><span style="color: #C678DD; font-style: italic">if</span><span style="color: #ABB2BF"> l </span><span style="color: #56B6C2">!=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">self</span><span style="color: #ABB2BF">.tokenizer.pad_token_id </span><span style="color: #C678DD; font-style: italic">else</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #D19A66">100</span><span style="color: #ABB2BF">) </span><span style="color: #C678DD; font-style: italic">for</span><span style="color: #ABB2BF"> l </span><span style="color: #C678DD; font-style: italic">in</span><span style="color: #ABB2BF"> label]</span></span>
<span class="line"><span style="color: #ABB2BF">            </span><span style="color: #C678DD; font-style: italic">for</span><span style="color: #ABB2BF"> label </span><span style="color: #C678DD; font-style: italic">in</span><span style="color: #ABB2BF"> tgt_text_tokenized.input_ids</span></span>
<span class="line"><span style="color: #ABB2BF">        ]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">        input_txt_tokenized.</span><span style="color: #61AFEF">update</span><span style="color: #ABB2BF">({</span><span style="color: #98C379">"tgt"</span><span style="color: #ABB2BF">: tgt_text_tokenized[</span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">]})</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">        batch </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF">            k: torch.</span><span style="color: #61AFEF">tensor</span><span style="color: #ABB2BF">(v).</span><span style="color: #61AFEF">squeeze</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">) </span><span style="color: #C678DD; font-style: italic">for</span><span style="color: #ABB2BF"> (k, v) </span><span style="color: #C678DD; font-style: italic">in</span><span style="color: #ABB2BF"> input_txt_tokenized.</span><span style="color: #61AFEF">items</span><span style="color: #ABB2BF">()</span></span>
<span class="line"><span style="color: #ABB2BF">        }</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #C678DD; font-style: italic">return</span><span style="color: #ABB2BF"> batch</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">def</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">__len__</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B; font-style: italic">self</span><span style="color: #ABB2BF">):</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #C678DD; font-style: italic">return</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">self</span><span style="color: #ABB2BF">.length_dataset</span></span>
<span class="line"></span></code></pre><button class="absolute top-1 right-1 copyBtn">
      <svg id="copyIt" class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" width="32" height="32" preserveAspectRatio="xMidYMid meet" viewBox="0 0 32 32"><path d="M28 10v18H10V10h18m0-2H10a2 2 0 0 0-2 2v18a2 2 0 0 0 2 2h18a2 2 0 0 0 2-2V10a2 2 0 0 0-2-2z" fill="#fff"></path><path d="M4 18H2V4a2 2 0 0 1 2-2h14v2H4z" fill="#fff"></path></svg>
      <svg id="copyDone" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="#0f0">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      </button></div><div class="highlight"><pre class="shiki one-dark-pro" style="background-color: #282c34"><code><span class="line"><span style="color: #ABB2BF">train_data </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">TransformerDataset</span><span style="color: #ABB2BF">(</span></span>
<span class="line"><span style="color: #ABB2BF">    train_dataset,</span></span>
<span class="line"><span style="color: #ABB2BF">    dataset_configs[</span><span style="color: #98C379">"source_text_id"</span><span style="color: #ABB2BF">],</span></span>
<span class="line"><span style="color: #ABB2BF">    dataset_configs[</span><span style="color: #98C379">"target_text_id"</span><span style="color: #ABB2BF">],</span></span>
<span class="line"><span style="color: #ABB2BF">    tokenizer,</span></span>
<span class="line"><span style="color: #ABB2BF">    dataset_configs[</span><span style="color: #98C379">"max_length"</span><span style="color: #ABB2BF">],</span></span>
<span class="line"><span style="color: #ABB2BF">    dataset_configs[</span><span style="color: #98C379">"train_dataset_length"</span><span style="color: #ABB2BF">],</span></span>
<span class="line"><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">val_data </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">TransformerDataset</span><span style="color: #ABB2BF">(</span></span>
<span class="line"><span style="color: #ABB2BF">    validation_dataset,</span></span>
<span class="line"><span style="color: #ABB2BF">    dataset_configs[</span><span style="color: #98C379">"source_text_id"</span><span style="color: #ABB2BF">],</span></span>
<span class="line"><span style="color: #ABB2BF">    dataset_configs[</span><span style="color: #98C379">"target_text_id"</span><span style="color: #ABB2BF">],</span></span>
<span class="line"><span style="color: #ABB2BF">    tokenizer,</span></span>
<span class="line"><span style="color: #ABB2BF">    dataset_configs[</span><span style="color: #98C379">"max_length"</span><span style="color: #ABB2BF">],</span></span>
<span class="line"><span style="color: #ABB2BF">    dataset_configs[</span><span style="color: #98C379">"validation_dataset_length"</span><span style="color: #ABB2BF">],</span></span>
<span class="line"><span style="color: #ABB2BF">)</span></span>
<span class="line"></span></code></pre><button class="absolute top-1 right-1 copyBtn">
      <svg id="copyIt" class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" width="32" height="32" preserveAspectRatio="xMidYMid meet" viewBox="0 0 32 32"><path d="M28 10v18H10V10h18m0-2H10a2 2 0 0 0-2 2v18a2 2 0 0 0 2 2h18a2 2 0 0 0 2-2V10a2 2 0 0 0-2-2z" fill="#fff"></path><path d="M4 18H2V4a2 2 0 0 1 2-2h14v2H4z" fill="#fff"></path></svg>
      <svg id="copyDone" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="#0f0">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      </button></div>
<h2 id="trainer">
<a href="#trainer" class="header-anchor">
Trainer
</a>
</h2><p>The trainer takes a batch of input and passes them through the model (along with targets in this case) and gets the loss.</p>
<h4 id="mixed-precision">
<a href="#mixed-precision" class="header-anchor">
Mixed Precision
</a>
</h4><p>The forward pass is wrapped in the autocast context manager for mixed precision training. It’s turned off in this example as there won’t be any memory advantages with <code>batch_size</code> 1 or 2. Change the <code>with_amp</code> flag in config to turn it on.</p>
<h4 id="gradient-accumulation">
<a href="#gradient-accumulation" class="header-anchor">
Gradient Accumulation
</a>
</h4><p>Gradient accumulation is implemented as batch size of 1 would lead to noisy updates otherwise. Check the <code>accumulation_steps</code> variable in config to define the number of steps to accumulate the gradient.</p>
<h4 id="trainer-handlers">
<a href="#trainer-handlers" class="header-anchor">
Trainer Handlers
</a>
</h4><p>Handlers can be defined and attached directly to the trainer engine. Here we also make use of a special function : <code>setup_common_training_handlers</code> which has a lot of the commonly used, useful handlers (like <code>save_every_iters</code>, <code>clear_cuda_cache</code>, etc) already defined. To know more about this function, refer to the docs
<a href="https://pytorch.org/ignite/contrib/engines.html#ignite.contrib.engines.common.setup_common_training_handlers" target="_blank" rel="noopener noreferrer">here</a>.</p>
<div class="highlight"><pre class="shiki one-dark-pro" style="background-color: #282c34"><code><span class="line"><span style="color: #7F848E; font-style: italic"># Create Trainer</span></span>
<span class="line"><span style="color: #C678DD">def</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">create_trainer</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66; font-style: italic">model</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66; font-style: italic">optimizer</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66; font-style: italic">with_amp</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66; font-style: italic">train_sampler</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66; font-style: italic">logger</span><span style="color: #ABB2BF">):</span></span>
<span class="line"><span style="color: #ABB2BF">    device </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> idist.</span><span style="color: #61AFEF">device</span><span style="color: #ABB2BF">()</span></span>
<span class="line"><span style="color: #ABB2BF">    scaler </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">GradScaler</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75; font-style: italic">enabled</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF">with_amp)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">def</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">train_step</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66; font-style: italic">engine</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66; font-style: italic">batch</span><span style="color: #ABB2BF">):</span></span>
<span class="line"><span style="color: #ABB2BF">        model.</span><span style="color: #61AFEF">train</span><span style="color: #ABB2BF">()</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #C678DD; font-style: italic">if</span><span style="color: #ABB2BF"> batch[</span><span style="color: #98C379">"tgt"</span><span style="color: #ABB2BF">].device </span><span style="color: #56B6C2">!=</span><span style="color: #ABB2BF"> device:</span></span>
<span class="line"><span style="color: #ABB2BF">            batch </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF">                k: v.</span><span style="color: #61AFEF">to</span><span style="color: #ABB2BF">(device, </span><span style="color: #E06C75; font-style: italic">non_blocking</span><span style="color: #56B6C2">=</span><span style="color: #D19A66">True</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75; font-style: italic">dtype</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF">torch.long)</span></span>
<span class="line"><span style="color: #ABB2BF">                </span><span style="color: #C678DD; font-style: italic">for</span><span style="color: #ABB2BF"> (k, v) </span><span style="color: #C678DD; font-style: italic">in</span><span style="color: #ABB2BF"> batch.</span><span style="color: #61AFEF">items</span><span style="color: #ABB2BF">()</span></span>
<span class="line"><span style="color: #ABB2BF">            }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">        src_ids </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> batch[</span><span style="color: #98C379">"input_ids"</span><span style="color: #ABB2BF">]</span></span>
<span class="line"><span style="color: #ABB2BF">        src_attention_mask </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> batch[</span><span style="color: #98C379">"attention_mask"</span><span style="color: #ABB2BF">]</span></span>
<span class="line"><span style="color: #ABB2BF">        tgt </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> batch[</span><span style="color: #98C379">"tgt"</span><span style="color: #ABB2BF">]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #C678DD; font-style: italic">with</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">autocast</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75; font-style: italic">enabled</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF">with_amp):</span></span>
<span class="line"><span style="color: #ABB2BF">            y </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">model</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75; font-style: italic">input_ids</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF">src_ids, </span><span style="color: #E06C75; font-style: italic">attention_mask</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF">src_attention_mask, </span><span style="color: #E06C75; font-style: italic">labels</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF">tgt)</span></span>
<span class="line"><span style="color: #ABB2BF">            loss </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> y[</span><span style="color: #98C379">"loss"</span><span style="color: #ABB2BF">]</span></span>
<span class="line"><span style="color: #ABB2BF">            loss </span><span style="color: #56B6C2">/=</span><span style="color: #ABB2BF"> config[</span><span style="color: #98C379">"accumulation_steps"</span><span style="color: #ABB2BF">]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">        scaler.</span><span style="color: #61AFEF">scale</span><span style="color: #ABB2BF">(loss).</span><span style="color: #61AFEF">backward</span><span style="color: #ABB2BF">()</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #C678DD; font-style: italic">if</span><span style="color: #ABB2BF"> engine.state.iteration </span><span style="color: #56B6C2">%</span><span style="color: #ABB2BF"> config[</span><span style="color: #98C379">"accumulation_steps"</span><span style="color: #ABB2BF">] </span><span style="color: #56B6C2">==</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">:</span></span>
<span class="line"><span style="color: #ABB2BF">            scaler.</span><span style="color: #61AFEF">step</span><span style="color: #ABB2BF">(optimizer)</span></span>
<span class="line"><span style="color: #ABB2BF">            scaler.</span><span style="color: #61AFEF">update</span><span style="color: #ABB2BF">()</span></span>
<span class="line"><span style="color: #ABB2BF">            optimizer.</span><span style="color: #61AFEF">zero_grad</span><span style="color: #ABB2BF">()</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #C678DD; font-style: italic">return</span><span style="color: #ABB2BF"> {</span><span style="color: #98C379">"batch loss"</span><span style="color: #ABB2BF">: loss.</span><span style="color: #61AFEF">item</span><span style="color: #ABB2BF">()}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    trainer </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">Engine</span><span style="color: #ABB2BF">(train_step)</span></span>
<span class="line"><span style="color: #ABB2BF">    trainer.logger </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> logger</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    metric_names </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> [</span><span style="color: #98C379">"batch loss"</span><span style="color: #ABB2BF">]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    common.</span><span style="color: #61AFEF">setup_common_training_handlers</span><span style="color: #ABB2BF">(</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E06C75; font-style: italic">trainer</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF">trainer,</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E06C75; font-style: italic">train_sampler</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF">train_sampler,</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E06C75; font-style: italic">output_names</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF">metric_names,</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E06C75; font-style: italic">clear_cuda_cache</span><span style="color: #56B6C2">=</span><span style="color: #D19A66">False</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E06C75; font-style: italic">with_pbars</span><span style="color: #56B6C2">=</span><span style="color: #D19A66">True</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">    )</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD; font-style: italic">return</span><span style="color: #ABB2BF"> trainer</span></span>
<span class="line"></span></code></pre><button class="absolute top-1 right-1 copyBtn">
      <svg id="copyIt" class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" width="32" height="32" preserveAspectRatio="xMidYMid meet" viewBox="0 0 32 32"><path d="M28 10v18H10V10h18m0-2H10a2 2 0 0 0-2 2v18a2 2 0 0 0 2 2h18a2 2 0 0 0 2-2V10a2 2 0 0 0-2-2z" fill="#fff"></path><path d="M4 18H2V4a2 2 0 0 1 2-2h14v2H4z" fill="#fff"></path></svg>
      <svg id="copyDone" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="#0f0">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      </button></div>
<h2 id="evaluator">
<a href="#evaluator" class="header-anchor">
Evaluator
</a>
</h2><p>Similar to trainer we create an evaluator for validation step. Here we calculate metrics (like Bleu Score). To do this Bleu score requires the sentences and not the logits. the <code>ids_to_clean_text</code> function is used to do that.</p>
<p>The <code>print_output_every</code> flag can be changed if you want to change the frequency of printing output sentences.</p>
<div class="highlight"><pre class="shiki one-dark-pro" style="background-color: #282c34"><code><span class="line"><span style="color: #7F848E; font-style: italic"># Let's now setup evaluator engine to perform model's validation and compute metrics</span></span>
<span class="line"><span style="color: #C678DD">def</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">create_evaluator</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66; font-style: italic">model</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66; font-style: italic">tokenizer</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66; font-style: italic">metrics</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66; font-style: italic">logger</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66; font-style: italic">tag</span><span style="color: #ABB2BF">=</span><span style="color: #98C379">"val"</span><span style="color: #ABB2BF">):</span></span>
<span class="line"><span style="color: #ABB2BF">    device </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> idist.</span><span style="color: #61AFEF">device</span><span style="color: #ABB2BF">()</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">def</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">ids_to_clean_text</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66; font-style: italic">generated_ids</span><span style="color: #ABB2BF">):</span></span>
<span class="line"><span style="color: #ABB2BF">        gen_text </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> tokenizer.</span><span style="color: #61AFEF">batch_decode</span><span style="color: #ABB2BF">(generated_ids, </span><span style="color: #E06C75; font-style: italic">skip_special_tokens</span><span style="color: #56B6C2">=</span><span style="color: #D19A66">True</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #C678DD; font-style: italic">return</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">list</span><span style="color: #ABB2BF">(</span><span style="color: #56B6C2">map</span><span style="color: #ABB2BF">(</span><span style="color: #56B6C2">str</span><span style="color: #ABB2BF">.strip, gen_text))</span></span>
<span class="line"></span>
<span class="line"><span style="color: #61AFEF">    @torch</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">no_grad</span><span style="color: #ABB2BF">()</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">def</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">evaluate_step</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66; font-style: italic">engine</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66; font-style: italic">batch</span><span style="color: #ABB2BF">):</span></span>
<span class="line"><span style="color: #ABB2BF">        model.</span><span style="color: #61AFEF">eval</span><span style="color: #ABB2BF">()</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #C678DD; font-style: italic">if</span><span style="color: #ABB2BF"> batch[</span><span style="color: #98C379">"tgt"</span><span style="color: #ABB2BF">].device </span><span style="color: #56B6C2">!=</span><span style="color: #ABB2BF"> device:</span></span>
<span class="line"><span style="color: #ABB2BF">            batch </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF">                k: v.</span><span style="color: #61AFEF">to</span><span style="color: #ABB2BF">(device, </span><span style="color: #E06C75; font-style: italic">non_blocking</span><span style="color: #56B6C2">=</span><span style="color: #D19A66">True</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75; font-style: italic">dtype</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF">torch.long)</span></span>
<span class="line"><span style="color: #ABB2BF">                </span><span style="color: #C678DD; font-style: italic">for</span><span style="color: #ABB2BF"> (k, v) </span><span style="color: #C678DD; font-style: italic">in</span><span style="color: #ABB2BF"> batch.</span><span style="color: #61AFEF">items</span><span style="color: #ABB2BF">()</span></span>
<span class="line"><span style="color: #ABB2BF">            }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">        src_ids </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> batch[</span><span style="color: #98C379">"input_ids"</span><span style="color: #ABB2BF">]</span></span>
<span class="line"><span style="color: #ABB2BF">        src_attention_mask </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> batch[</span><span style="color: #98C379">"attention_mask"</span><span style="color: #ABB2BF">]</span></span>
<span class="line"><span style="color: #ABB2BF">        tgt </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> batch[</span><span style="color: #98C379">"tgt"</span><span style="color: #ABB2BF">]</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #C678DD; font-style: italic">if</span><span style="color: #ABB2BF"> idist.</span><span style="color: #61AFEF">get_world_size</span><span style="color: #ABB2BF">() </span><span style="color: #56B6C2">&gt;</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">:</span></span>
<span class="line"><span style="color: #ABB2BF">            y_pred </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> model.module.</span><span style="color: #61AFEF">generate</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75; font-style: italic">input_ids</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF">src_ids, </span><span style="color: #E06C75; font-style: italic">attention_mask</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF">src_attention_mask)</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #C678DD; font-style: italic">else</span><span style="color: #ABB2BF">:   </span></span>
<span class="line"><span style="color: #ABB2BF">            y_pred </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> model.</span><span style="color: #61AFEF">generate</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75; font-style: italic">input_ids</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF">src_ids, </span><span style="color: #E06C75; font-style: italic">attention_mask</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF">src_attention_mask)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">        tgt </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> torch.</span><span style="color: #61AFEF">where</span><span style="color: #ABB2BF">(tgt </span><span style="color: #56B6C2">!=</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #D19A66">100</span><span style="color: #ABB2BF">, tgt, tokenizer.pad_token_id)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">        preds </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">ids_to_clean_text</span><span style="color: #ABB2BF">(y_pred)</span></span>
<span class="line"><span style="color: #ABB2BF">        tgt </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">ids_to_clean_text</span><span style="color: #ABB2BF">(tgt)</span></span>
<span class="line"><span style="color: #ABB2BF">        preds </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> [_preds.</span><span style="color: #61AFEF">split</span><span style="color: #ABB2BF">() </span><span style="color: #C678DD; font-style: italic">for</span><span style="color: #ABB2BF"> _preds </span><span style="color: #C678DD; font-style: italic">in</span><span style="color: #ABB2BF"> preds]</span></span>
<span class="line"><span style="color: #ABB2BF">        tgt </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> [[_tgt.</span><span style="color: #61AFEF">split</span><span style="color: #ABB2BF">()] </span><span style="color: #C678DD; font-style: italic">for</span><span style="color: #ABB2BF"> _tgt </span><span style="color: #C678DD; font-style: italic">in</span><span style="color: #ABB2BF"> tgt]</span></span>
<span class="line"><span style="color: #ABB2BF">        </span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #C678DD; font-style: italic">if</span><span style="color: #ABB2BF"> engine.state.iteration </span><span style="color: #56B6C2">%</span><span style="color: #ABB2BF"> config[</span><span style="color: #98C379">"print_output_every"</span><span style="color: #ABB2BF">] </span><span style="color: #56B6C2">==</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">:</span></span>
<span class="line"><span style="color: #ABB2BF">            logger.</span><span style="color: #61AFEF">info</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">f</span><span style="color: #98C379">'</span><span style="color: #56B6C2">\n</span><span style="color: #98C379"> Preds : </span><span style="color: #D19A66">{</span><span style="color: #98C379">" "</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">join</span><span style="color: #ABB2BF">(preds[</span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">])</span><span style="color: #D19A66">}</span><span style="color: #98C379"> </span><span style="color: #56B6C2">\n</span><span style="color: #98C379">'</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">            logger.</span><span style="color: #61AFEF">info</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">f</span><span style="color: #98C379">'</span><span style="color: #56B6C2">\n</span><span style="color: #98C379"> Target : </span><span style="color: #D19A66">{</span><span style="color: #98C379">" "</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">join</span><span style="color: #ABB2BF">(tgt[</span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">][</span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">])</span><span style="color: #D19A66">}</span><span style="color: #98C379"> </span><span style="color: #56B6C2">\n</span><span style="color: #98C379">'</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #C678DD; font-style: italic">return</span><span style="color: #ABB2BF"> preds, tgt</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    evaluator </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">Engine</span><span style="color: #ABB2BF">(evaluate_step)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD; font-style: italic">for</span><span style="color: #ABB2BF"> name, metric </span><span style="color: #C678DD; font-style: italic">in</span><span style="color: #ABB2BF"> metrics.</span><span style="color: #61AFEF">items</span><span style="color: #ABB2BF">():</span></span>
<span class="line"><span style="color: #ABB2BF">        metric.</span><span style="color: #61AFEF">attach</span><span style="color: #ABB2BF">(evaluator, name)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD; font-style: italic">return</span><span style="color: #ABB2BF"> evaluator</span></span>
<span class="line"></span></code></pre><button class="absolute top-1 right-1 copyBtn">
      <svg id="copyIt" class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" width="32" height="32" preserveAspectRatio="xMidYMid meet" viewBox="0 0 32 32"><path d="M28 10v18H10V10h18m0-2H10a2 2 0 0 0-2 2v18a2 2 0 0 0 2 2h18a2 2 0 0 0 2-2V10a2 2 0 0 0-2-2z" fill="#fff"></path><path d="M4 18H2V4a2 2 0 0 1 2-2h14v2H4z" fill="#fff"></path></svg>
      <svg id="copyDone" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="#0f0">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      </button></div>
<h2 id="initializing-functions">
<a href="#initializing-functions" class="header-anchor">
Initializing Functions
</a>
</h2><p>Here we initialize the model and optimizer.<br>
The <code>get_dataloader</code> returns dataloaders for train and validation.</p>
<div class="highlight"><pre class="shiki one-dark-pro" style="background-color: #282c34"><code><span class="line"><span style="color: #C678DD">def</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">freeze_params</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66; font-style: italic">model</span><span style="color: #ABB2BF">):</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD; font-style: italic">for</span><span style="color: #ABB2BF"> par </span><span style="color: #C678DD; font-style: italic">in</span><span style="color: #ABB2BF"> model.</span><span style="color: #61AFEF">parameters</span><span style="color: #ABB2BF">():</span></span>
<span class="line"><span style="color: #ABB2BF">        par.requires_grad </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">False</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">def</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">initialize</span><span style="color: #ABB2BF">():</span></span>
<span class="line"><span style="color: #ABB2BF">    model </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> T5ForConditionalGeneration.</span><span style="color: #61AFEF">from_pretrained</span><span style="color: #ABB2BF">(config[</span><span style="color: #98C379">"model_name"</span><span style="color: #ABB2BF">])</span></span>
<span class="line"><span style="color: #ABB2BF">    lr </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> config[</span><span style="color: #98C379">"learning_rate"</span><span style="color: #ABB2BF">] </span><span style="color: #56B6C2">*</span><span style="color: #ABB2BF"> idist.</span><span style="color: #61AFEF">get_world_size</span><span style="color: #ABB2BF">()</span></span>
<span class="line"><span style="color: #ABB2BF">    no_decay </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> [</span><span style="color: #98C379">"bias"</span><span style="color: #ABB2BF">, </span><span style="color: #98C379">"LayerNorm.weight"</span><span style="color: #ABB2BF">]</span></span>
<span class="line"><span style="color: #ABB2BF">    optimizer_grouped_parameters </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> [</span></span>
<span class="line"><span style="color: #ABB2BF">        {</span></span>
<span class="line"><span style="color: #ABB2BF">            </span><span style="color: #98C379">"params"</span><span style="color: #ABB2BF">: [</span></span>
<span class="line"><span style="color: #ABB2BF">                p</span></span>
<span class="line"><span style="color: #ABB2BF">                </span><span style="color: #C678DD; font-style: italic">for</span><span style="color: #ABB2BF"> n, p </span><span style="color: #C678DD; font-style: italic">in</span><span style="color: #ABB2BF"> model.</span><span style="color: #61AFEF">named_parameters</span><span style="color: #ABB2BF">()</span></span>
<span class="line"><span style="color: #ABB2BF">                </span><span style="color: #C678DD; font-style: italic">if</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD; font-style: italic">not</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">any</span><span style="color: #ABB2BF">(nd </span><span style="color: #C678DD; font-style: italic">in</span><span style="color: #ABB2BF"> n </span><span style="color: #C678DD; font-style: italic">for</span><span style="color: #ABB2BF"> nd </span><span style="color: #C678DD; font-style: italic">in</span><span style="color: #ABB2BF"> no_decay)</span></span>
<span class="line"><span style="color: #ABB2BF">            ],</span></span>
<span class="line"><span style="color: #ABB2BF">            </span><span style="color: #98C379">"weight_decay"</span><span style="color: #ABB2BF">: config[</span><span style="color: #98C379">"weight_decay"</span><span style="color: #ABB2BF">],</span></span>
<span class="line"><span style="color: #ABB2BF">        },</span></span>
<span class="line"><span style="color: #ABB2BF">        {</span></span>
<span class="line"><span style="color: #ABB2BF">            </span><span style="color: #98C379">"params"</span><span style="color: #ABB2BF">: [</span></span>
<span class="line"><span style="color: #ABB2BF">                p</span></span>
<span class="line"><span style="color: #ABB2BF">                </span><span style="color: #C678DD; font-style: italic">for</span><span style="color: #ABB2BF"> n, p </span><span style="color: #C678DD; font-style: italic">in</span><span style="color: #ABB2BF"> model.</span><span style="color: #61AFEF">named_parameters</span><span style="color: #ABB2BF">()</span></span>
<span class="line"><span style="color: #ABB2BF">                </span><span style="color: #C678DD; font-style: italic">if</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">any</span><span style="color: #ABB2BF">(nd </span><span style="color: #C678DD; font-style: italic">in</span><span style="color: #ABB2BF"> n </span><span style="color: #C678DD; font-style: italic">for</span><span style="color: #ABB2BF"> nd </span><span style="color: #C678DD; font-style: italic">in</span><span style="color: #ABB2BF"> no_decay)</span></span>
<span class="line"><span style="color: #ABB2BF">            ],</span></span>
<span class="line"><span style="color: #ABB2BF">            </span><span style="color: #98C379">"weight_decay"</span><span style="color: #ABB2BF">: </span><span style="color: #D19A66">0.0</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">        },</span></span>
<span class="line"><span style="color: #ABB2BF">    ]</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD; font-style: italic">if</span><span style="color: #ABB2BF"> config[</span><span style="color: #98C379">"freeze_encoder"</span><span style="color: #ABB2BF">]:</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #61AFEF">freeze_params</span><span style="color: #ABB2BF">(model.</span><span style="color: #61AFEF">get_encoder</span><span style="color: #ABB2BF">())</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    model </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> idist.</span><span style="color: #61AFEF">auto_model</span><span style="color: #ABB2BF">(model)</span></span>
<span class="line"><span style="color: #ABB2BF">    optimizer </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> optim.</span><span style="color: #61AFEF">AdamW</span><span style="color: #ABB2BF">(optimizer_grouped_parameters, </span><span style="color: #E06C75; font-style: italic">lr</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF">lr)</span></span>
<span class="line"><span style="color: #ABB2BF">    optimizer </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> idist.</span><span style="color: #61AFEF">auto_optim</span><span style="color: #ABB2BF">(optimizer)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD; font-style: italic">return</span><span style="color: #ABB2BF"> model, optimizer</span></span>
<span class="line"></span></code></pre><button class="absolute top-1 right-1 copyBtn">
      <svg id="copyIt" class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" width="32" height="32" preserveAspectRatio="xMidYMid meet" viewBox="0 0 32 32"><path d="M28 10v18H10V10h18m0-2H10a2 2 0 0 0-2 2v18a2 2 0 0 0 2 2h18a2 2 0 0 0 2-2V10a2 2 0 0 0-2-2z" fill="#fff"></path><path d="M4 18H2V4a2 2 0 0 1 2-2h14v2H4z" fill="#fff"></path></svg>
      <svg id="copyDone" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="#0f0">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      </button></div><div class="highlight"><pre class="shiki one-dark-pro" style="background-color: #282c34"><code><span class="line"><span style="color: #C678DD">def</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">get_dataloaders</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66; font-style: italic">train_dataset</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66; font-style: italic">val_dataset</span><span style="color: #ABB2BF">):</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #7F848E; font-style: italic"># Setup data loader also adapted to distributed config: nccl, gloo, xla-tpu</span></span>
<span class="line"><span style="color: #ABB2BF">    train_loader </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> idist.</span><span style="color: #61AFEF">auto_dataloader</span><span style="color: #ABB2BF">(</span></span>
<span class="line"><span style="color: #ABB2BF">        train_dataset,</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E06C75; font-style: italic">batch_size</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF">config[</span><span style="color: #98C379">"batch_size"</span><span style="color: #ABB2BF">],</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E06C75; font-style: italic">num_workers</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF">config[</span><span style="color: #98C379">"num_workers"</span><span style="color: #ABB2BF">],</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E06C75; font-style: italic">shuffle</span><span style="color: #56B6C2">=</span><span style="color: #D19A66">True</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E06C75; font-style: italic">drop_last</span><span style="color: #56B6C2">=</span><span style="color: #D19A66">True</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">    )</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    val_loader </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> idist.</span><span style="color: #61AFEF">auto_dataloader</span><span style="color: #ABB2BF">(</span></span>
<span class="line"><span style="color: #ABB2BF">        val_dataset,</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E06C75; font-style: italic">batch_size</span><span style="color: #56B6C2">=</span><span style="color: #D19A66">2</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">*</span><span style="color: #ABB2BF"> config[</span><span style="color: #98C379">"batch_size"</span><span style="color: #ABB2BF">],</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E06C75; font-style: italic">num_workers</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF">config[</span><span style="color: #98C379">"num_workers"</span><span style="color: #ABB2BF">],</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E06C75; font-style: italic">shuffle</span><span style="color: #56B6C2">=</span><span style="color: #D19A66">False</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">    )</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD; font-style: italic">return</span><span style="color: #ABB2BF"> train_loader, val_loader</span></span>
<span class="line"></span></code></pre><button class="absolute top-1 right-1 copyBtn">
      <svg id="copyIt" class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" width="32" height="32" preserveAspectRatio="xMidYMid meet" viewBox="0 0 32 32"><path d="M28 10v18H10V10h18m0-2H10a2 2 0 0 0-2 2v18a2 2 0 0 0 2 2h18a2 2 0 0 0 2-2V10a2 2 0 0 0-2-2z" fill="#fff"></path><path d="M4 18H2V4a2 2 0 0 1 2-2h14v2H4z" fill="#fff"></path></svg>
      <svg id="copyDone" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="#0f0">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      </button></div>
<h2 id="logging-handlers">
<a href="#logging-handlers" class="header-anchor">
Logging Handlers
</a>
</h2><p>This step is optional, however, we can pass a <code>setup_logger()</code> object to <code>log_basic_info()</code> and log all basic information such as different versions, current configuration, device and backend used by the current process (identified by its local rank), and number of processes (<code>world size</code>). idist (<code>ignite.distributed</code>) provides several utility functions like <code>get_local_rank()</code>, <code>backend()</code>, <code>get_world_size()</code>, etc. to make this possible.</p>
<p>The <code>log_metrics_eval</code> is used to log metrics and evaluation time for running evaluation.</p>
<p>The <code>get_save_handler</code> is used to save the model to the output path whenever it is called.</p>
<div class="highlight"><pre class="shiki one-dark-pro" style="background-color: #282c34"><code><span class="line"><span style="color: #C678DD">def</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">log_metrics_eval</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66; font-style: italic">logger</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66; font-style: italic">epoch</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66; font-style: italic">elapsed</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66; font-style: italic">tag</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66; font-style: italic">metrics</span><span style="color: #ABB2BF">):</span></span>
<span class="line"><span style="color: #ABB2BF">    metrics_output </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">"</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">"</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">join</span><span style="color: #ABB2BF">([</span><span style="color: #C678DD">f</span><span style="color: #98C379">"</span><span style="color: #56B6C2">\t</span><span style="color: #D19A66">{</span><span style="color: #ABB2BF">k</span><span style="color: #D19A66">}</span><span style="color: #98C379">: </span><span style="color: #D19A66">{</span><span style="color: #ABB2BF">v</span><span style="color: #D19A66">}</span><span style="color: #98C379">"</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD; font-style: italic">for</span><span style="color: #ABB2BF"> k, v </span><span style="color: #C678DD; font-style: italic">in</span><span style="color: #ABB2BF"> metrics.</span><span style="color: #61AFEF">items</span><span style="color: #ABB2BF">()])</span></span>
<span class="line"><span style="color: #ABB2BF">    logger.</span><span style="color: #61AFEF">info</span><span style="color: #ABB2BF">(</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #C678DD">f</span><span style="color: #98C379">"</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">Epoch </span><span style="color: #D19A66">{</span><span style="color: #ABB2BF">epoch</span><span style="color: #D19A66">}</span><span style="color: #98C379"> - Evaluation time (seconds): </span><span style="color: #D19A66">{</span><span style="color: #ABB2BF">elapsed</span><span style="color: #C678DD">:.2f</span><span style="color: #D19A66">}</span><span style="color: #98C379"> - </span><span style="color: #D19A66">{</span><span style="color: #ABB2BF">tag</span><span style="color: #D19A66">}</span><span style="color: #98C379"> metrics:</span><span style="color: #56B6C2">\n</span><span style="color: #98C379"> </span><span style="color: #D19A66">{</span><span style="color: #ABB2BF">metrics_output</span><span style="color: #D19A66">}</span><span style="color: #98C379">"</span></span>
<span class="line"><span style="color: #ABB2BF">    )</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">def</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">log_basic_info</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66; font-style: italic">logger</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66; font-style: italic">config</span><span style="color: #ABB2BF">):</span></span>
<span class="line"><span style="color: #ABB2BF">    logger.</span><span style="color: #61AFEF">info</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">f</span><span style="color: #98C379">"Train on CIFAR10"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">    logger.</span><span style="color: #61AFEF">info</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">f</span><span style="color: #98C379">"- PyTorch version: </span><span style="color: #D19A66">{</span><span style="color: #ABB2BF">torch.</span><span style="color: #E06C75">__version__</span><span style="color: #D19A66">}</span><span style="color: #98C379">"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">    logger.</span><span style="color: #61AFEF">info</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">f</span><span style="color: #98C379">"- Ignite version: </span><span style="color: #D19A66">{</span><span style="color: #ABB2BF">ignite.</span><span style="color: #E06C75">__version__</span><span style="color: #D19A66">}</span><span style="color: #98C379">"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD; font-style: italic">if</span><span style="color: #ABB2BF"> torch.cuda.</span><span style="color: #61AFEF">is_available</span><span style="color: #ABB2BF">():</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #7F848E; font-style: italic"># explicitly import cudnn as torch.backends.cudnn can not be pickled with hvd spawning procs</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #C678DD; font-style: italic">from</span><span style="color: #ABB2BF"> torch.backends </span><span style="color: #C678DD; font-style: italic">import</span><span style="color: #ABB2BF"> cudnn</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">        logger.</span><span style="color: #61AFEF">info</span><span style="color: #ABB2BF">(</span></span>
<span class="line"><span style="color: #ABB2BF">            </span><span style="color: #C678DD">f</span><span style="color: #98C379">"- GPU Device: </span><span style="color: #D19A66">{</span><span style="color: #ABB2BF">torch.cuda.</span><span style="color: #61AFEF">get_device_name</span><span style="color: #ABB2BF">(idist.</span><span style="color: #61AFEF">get_local_rank</span><span style="color: #ABB2BF">())</span><span style="color: #D19A66">}</span><span style="color: #98C379">"</span></span>
<span class="line"><span style="color: #ABB2BF">        )</span></span>
<span class="line"><span style="color: #ABB2BF">        logger.</span><span style="color: #61AFEF">info</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">f</span><span style="color: #98C379">"- CUDA version: </span><span style="color: #D19A66">{</span><span style="color: #ABB2BF">torch.version.cuda</span><span style="color: #D19A66">}</span><span style="color: #98C379">"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">        logger.</span><span style="color: #61AFEF">info</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">f</span><span style="color: #98C379">"- CUDNN version: </span><span style="color: #D19A66">{</span><span style="color: #ABB2BF">cudnn.</span><span style="color: #61AFEF">version</span><span style="color: #ABB2BF">()</span><span style="color: #D19A66">}</span><span style="color: #98C379">"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    logger.</span><span style="color: #61AFEF">info</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">    logger.</span><span style="color: #61AFEF">info</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"Configuration:"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD; font-style: italic">for</span><span style="color: #ABB2BF"> key, value </span><span style="color: #C678DD; font-style: italic">in</span><span style="color: #ABB2BF"> config.</span><span style="color: #61AFEF">items</span><span style="color: #ABB2BF">():</span></span>
<span class="line"><span style="color: #ABB2BF">        logger.</span><span style="color: #61AFEF">info</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">f</span><span style="color: #98C379">"</span><span style="color: #56B6C2">\t</span><span style="color: #D19A66">{</span><span style="color: #ABB2BF">key</span><span style="color: #D19A66">}</span><span style="color: #98C379">: </span><span style="color: #D19A66">{</span><span style="color: #ABB2BF">value</span><span style="color: #D19A66">}</span><span style="color: #98C379">"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">    logger.</span><span style="color: #61AFEF">info</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD; font-style: italic">if</span><span style="color: #ABB2BF"> idist.</span><span style="color: #61AFEF">get_world_size</span><span style="color: #ABB2BF">() </span><span style="color: #56B6C2">&gt;</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">:</span></span>
<span class="line"><span style="color: #ABB2BF">        logger.</span><span style="color: #61AFEF">info</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">Distributed setting:"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">        logger.</span><span style="color: #61AFEF">info</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">f</span><span style="color: #98C379">"</span><span style="color: #56B6C2">\t</span><span style="color: #98C379">backend: </span><span style="color: #D19A66">{</span><span style="color: #ABB2BF">idist.</span><span style="color: #61AFEF">backend</span><span style="color: #ABB2BF">()</span><span style="color: #D19A66">}</span><span style="color: #98C379">"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">        logger.</span><span style="color: #61AFEF">info</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">f</span><span style="color: #98C379">"</span><span style="color: #56B6C2">\t</span><span style="color: #98C379">world size: </span><span style="color: #D19A66">{</span><span style="color: #ABB2BF">idist.</span><span style="color: #61AFEF">get_world_size</span><span style="color: #ABB2BF">()</span><span style="color: #D19A66">}</span><span style="color: #98C379">"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">        logger.</span><span style="color: #61AFEF">info</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">def</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">get_save_handler</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66; font-style: italic">config</span><span style="color: #ABB2BF">):</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD; font-style: italic">return</span><span style="color: #ABB2BF"> config[</span><span style="color: #98C379">"output_path_"</span><span style="color: #ABB2BF">]</span></span>
<span class="line"></span></code></pre><button class="absolute top-1 right-1 copyBtn">
      <svg id="copyIt" class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" width="32" height="32" preserveAspectRatio="xMidYMid meet" viewBox="0 0 32 32"><path d="M28 10v18H10V10h18m0-2H10a2 2 0 0 0-2 2v18a2 2 0 0 0 2 2h18a2 2 0 0 0 2-2V10a2 2 0 0 0-2-2z" fill="#fff"></path><path d="M4 18H2V4a2 2 0 0 1 2-2h14v2H4z" fill="#fff"></path></svg>
      <svg id="copyDone" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="#0f0">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      </button></div>
<h2 id="begin-training">
<a href="#begin-training" class="header-anchor">
Begin Training
</a>
</h2><p>This is where the main logic resides, i.e. we will call all the above functions from within here:</p>
<ol>
<li>Basic Setup
<ol>
<li>We set a <code>manual_seed()</code> and <code>setup_logger()</code>, then log all basic information.</li>
<li>Initialise dataloaders, model and optimizer.</li>
</ol>
</li>
<li>We use the above objects to create a trainer.</li>
<li>Evaluator
<ol>
<li>Define some relevant Ignite metrics like <code>Bleu()</code>.</li>
<li>Create evaluator: <code>evaluator</code> to compute metrics on the <code>val_dataloader</code>.</li>
<li>Define <code>run_validation()</code> to compute metrics on both dataloaders and log them. Then we attach this function to trainer to run after epochs.</li>
</ol>
</li>
<li>Setup TensorBoard logging using <code>setup_tb_logging()</code> on the master process for the evaluators so that validation metrics along with the learning rate can be logged.</li>
<li>Define a <code>Checkpoint()</code> object to store the two best models (<code>n_saved</code>) by validation accuracy (defined in metrics as <code>Bleu()</code>) and attach it to val_evaluator so that it can be executed everytime <code>evaluator</code> runs.</li>
<li>Try training on <code>train_loader</code> for <code>num_epochs</code></li>
<li>Close Tensorboard logger once training is completed.</li>
</ol>
<div class="highlight"><pre class="shiki one-dark-pro" style="background-color: #282c34"><code><span class="line"><span style="color: #C678DD">def</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">training</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66; font-style: italic">local_rank</span><span style="color: #ABB2BF">):</span></span>
<span class="line"><span style="color: #ABB2BF">    rank </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> idist.</span><span style="color: #61AFEF">get_rank</span><span style="color: #ABB2BF">()</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #61AFEF">manual_seed</span><span style="color: #ABB2BF">(config[</span><span style="color: #98C379">"seed"</span><span style="color: #ABB2BF">] </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> rank)</span></span>
<span class="line"><span style="color: #ABB2BF">    device </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> idist.</span><span style="color: #61AFEF">device</span><span style="color: #ABB2BF">()</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    logger </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">setup_logger</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75; font-style: italic">name</span><span style="color: #56B6C2">=</span><span style="color: #98C379">"NMT"</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75; font-style: italic">distributed_rank</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF">local_rank)</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #61AFEF">log_basic_info</span><span style="color: #ABB2BF">(logger, config)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    train_loader, val_loader </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">get_dataloaders</span><span style="color: #ABB2BF">(train_data, val_data)</span></span>
<span class="line"><span style="color: #ABB2BF">    model, optimizer </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">initialize</span><span style="color: #ABB2BF">()</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    trainer </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">create_trainer</span><span style="color: #ABB2BF">(</span></span>
<span class="line"><span style="color: #ABB2BF">        model, optimizer, config[</span><span style="color: #98C379">"with_amp"</span><span style="color: #ABB2BF">], train_loader.sampler, logger</span></span>
<span class="line"><span style="color: #ABB2BF">    )</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    metrics </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #98C379">"bleu"</span><span style="color: #ABB2BF">: </span><span style="color: #61AFEF">Bleu</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75; font-style: italic">ngram</span><span style="color: #56B6C2">=</span><span style="color: #D19A66">4</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75; font-style: italic">smooth</span><span style="color: #56B6C2">=</span><span style="color: #98C379">"smooth1"</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75; font-style: italic">average</span><span style="color: #56B6C2">=</span><span style="color: #98C379">"micro"</span><span style="color: #ABB2BF">),</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #98C379">"bleu_smooth_2"</span><span style="color: #ABB2BF">: </span><span style="color: #61AFEF">Bleu</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75; font-style: italic">ngram</span><span style="color: #56B6C2">=</span><span style="color: #D19A66">4</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75; font-style: italic">smooth</span><span style="color: #56B6C2">=</span><span style="color: #98C379">"smooth2"</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75; font-style: italic">average</span><span style="color: #56B6C2">=</span><span style="color: #98C379">"micro"</span><span style="color: #ABB2BF">),</span></span>
<span class="line"><span style="color: #ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    evaluator </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">create_evaluator</span><span style="color: #ABB2BF">(</span></span>
<span class="line"><span style="color: #ABB2BF">        model, tokenizer, metrics, logger, </span><span style="color: #E06C75; font-style: italic">tag</span><span style="color: #56B6C2">=</span><span style="color: #98C379">"val"</span></span>
<span class="line"><span style="color: #ABB2BF">    )</span></span>
<span class="line"></span>
<span class="line"><span style="color: #61AFEF">    @trainer</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">on</span><span style="color: #ABB2BF">(</span><span style="color: #61AFEF">Events</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">EPOCH_COMPLETED</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75; font-style: italic">every</span><span style="color: #56B6C2">=</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">)</span><span style="color: #61AFEF"> </span><span style="color: #56B6C2">|</span><span style="color: #61AFEF"> Events</span><span style="color: #ABB2BF">.</span><span style="color: #D19A66">COMPLETED</span><span style="color: #61AFEF"> </span><span style="color: #56B6C2">|</span><span style="color: #61AFEF"> Events</span><span style="color: #ABB2BF">.</span><span style="color: #D19A66">STARTED</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">def</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">run_validation</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66; font-style: italic">engine</span><span style="color: #ABB2BF">):</span></span>
<span class="line"><span style="color: #ABB2BF">        epoch </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> trainer.state.epoch</span></span>
<span class="line"><span style="color: #ABB2BF">        state </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> evaluator.</span><span style="color: #61AFEF">run</span><span style="color: #ABB2BF">(val_loader)</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #61AFEF">log_metrics_eval</span><span style="color: #ABB2BF">(</span></span>
<span class="line"><span style="color: #ABB2BF">            logger, epoch, state.times[</span><span style="color: #98C379">"COMPLETED"</span><span style="color: #ABB2BF">], </span><span style="color: #98C379">"Validation"</span><span style="color: #ABB2BF">, state.metrics</span></span>
<span class="line"><span style="color: #ABB2BF">        )</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD; font-style: italic">if</span><span style="color: #ABB2BF"> rank </span><span style="color: #56B6C2">==</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">:</span></span>
<span class="line"><span style="color: #ABB2BF">        now </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> datetime.</span><span style="color: #61AFEF">now</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">strftime</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"%Y%m</span><span style="color: #D19A66">%d</span><span style="color: #98C379">-%H%M%S"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">        folder_name </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">f</span><span style="color: #98C379">"Translation_Model_backend-</span><span style="color: #D19A66">{</span><span style="color: #ABB2BF">idist.</span><span style="color: #61AFEF">backend</span><span style="color: #ABB2BF">()</span><span style="color: #D19A66">}</span><span style="color: #98C379">-</span><span style="color: #D19A66">{</span><span style="color: #ABB2BF">idist.</span><span style="color: #61AFEF">get_world_size</span><span style="color: #ABB2BF">()</span><span style="color: #D19A66">}</span><span style="color: #98C379">_</span><span style="color: #D19A66">{</span><span style="color: #ABB2BF">now</span><span style="color: #D19A66">}</span><span style="color: #98C379">"</span></span>
<span class="line"><span style="color: #ABB2BF">        output_path </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">Path</span><span style="color: #ABB2BF">(config[</span><span style="color: #98C379">"output_path_"</span><span style="color: #ABB2BF">]) </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF"> folder_name</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #C678DD; font-style: italic">if</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD; font-style: italic">not</span><span style="color: #ABB2BF"> output_path.</span><span style="color: #61AFEF">exists</span><span style="color: #ABB2BF">():</span></span>
<span class="line"><span style="color: #ABB2BF">            output_path.</span><span style="color: #61AFEF">mkdir</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75; font-style: italic">parents</span><span style="color: #56B6C2">=</span><span style="color: #D19A66">True</span><span style="color: #ABB2BF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">        logger.</span><span style="color: #61AFEF">info</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">f</span><span style="color: #98C379">"Output path: </span><span style="color: #D19A66">{</span><span style="color: #ABB2BF">output_path</span><span style="color: #D19A66">}</span><span style="color: #98C379">"</span><span style="color: #ABB2BF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">        evaluators </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> {</span><span style="color: #98C379">"val"</span><span style="color: #ABB2BF">: evaluator}</span></span>
<span class="line"><span style="color: #ABB2BF">        tb_logger </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> common.</span><span style="color: #61AFEF">setup_tb_logging</span><span style="color: #ABB2BF">(</span></span>
<span class="line"><span style="color: #ABB2BF">            config[</span><span style="color: #98C379">"output_path_"</span><span style="color: #ABB2BF">], trainer, optimizer, </span><span style="color: #E06C75; font-style: italic">evaluators</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF">evaluators</span></span>
<span class="line"><span style="color: #ABB2BF">        )</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    best_model_handler </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">Checkpoint</span><span style="color: #ABB2BF">(</span></span>
<span class="line"><span style="color: #ABB2BF">        {</span><span style="color: #98C379">"model"</span><span style="color: #ABB2BF">: model},</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #61AFEF">get_save_handler</span><span style="color: #ABB2BF">(config),</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E06C75; font-style: italic">filename_prefix</span><span style="color: #56B6C2">=</span><span style="color: #98C379">"best"</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E06C75; font-style: italic">n_saved</span><span style="color: #56B6C2">=</span><span style="color: #D19A66">2</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E06C75; font-style: italic">global_step_transform</span><span style="color: #56B6C2">=</span><span style="color: #61AFEF">global_step_from_engine</span><span style="color: #ABB2BF">(trainer),</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E06C75; font-style: italic">score_name</span><span style="color: #56B6C2">=</span><span style="color: #98C379">"val_bleu"</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E06C75; font-style: italic">score_function</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF">Checkpoint.</span><span style="color: #61AFEF">get_default_score_fn</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">"bleu"</span><span style="color: #ABB2BF">),</span></span>
<span class="line"><span style="color: #ABB2BF">    )</span></span>
<span class="line"><span style="color: #ABB2BF">    evaluator.</span><span style="color: #61AFEF">add_event_handler</span><span style="color: #ABB2BF">(Events.</span><span style="color: #D19A66">COMPLETED</span><span style="color: #ABB2BF">, best_model_handler)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD; font-style: italic">try</span><span style="color: #ABB2BF">:</span></span>
<span class="line"><span style="color: #ABB2BF">        state </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> trainer.</span><span style="color: #61AFEF">run</span><span style="color: #ABB2BF">(</span></span>
<span class="line"><span style="color: #ABB2BF">            train_loader,</span></span>
<span class="line"><span style="color: #ABB2BF">            </span><span style="color: #E06C75; font-style: italic">max_epochs</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF">config[</span><span style="color: #98C379">"num_epochs"</span><span style="color: #ABB2BF">],</span></span>
<span class="line"><span style="color: #ABB2BF">            </span><span style="color: #E06C75; font-style: italic">epoch_length</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF">config[</span><span style="color: #98C379">"epoch_length"</span><span style="color: #ABB2BF">],</span></span>
<span class="line"><span style="color: #ABB2BF">        )</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD; font-style: italic">except</span><span style="color: #ABB2BF"> Exception </span><span style="color: #C678DD; font-style: italic">as</span><span style="color: #ABB2BF"> e:</span></span>
<span class="line"><span style="color: #ABB2BF">        logger.</span><span style="color: #61AFEF">exception</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">""</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #C678DD; font-style: italic">raise</span><span style="color: #ABB2BF"> e</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD; font-style: italic">if</span><span style="color: #ABB2BF"> rank </span><span style="color: #56B6C2">==</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">:</span></span>
<span class="line"><span style="color: #ABB2BF">        tb_logger.</span><span style="color: #61AFEF">close</span><span style="color: #ABB2BF">()</span></span>
<span class="line"></span></code></pre><button class="absolute top-1 right-1 copyBtn">
      <svg id="copyIt" class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" width="32" height="32" preserveAspectRatio="xMidYMid meet" viewBox="0 0 32 32"><path d="M28 10v18H10V10h18m0-2H10a2 2 0 0 0-2 2v18a2 2 0 0 0 2 2h18a2 2 0 0 0 2-2V10a2 2 0 0 0-2-2z" fill="#fff"></path><path d="M4 18H2V4a2 2 0 0 1 2-2h14v2H4z" fill="#fff"></path></svg>
      <svg id="copyDone" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="#0f0">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      </button></div>
<h2 id="running">
<a href="#running" class="header-anchor">
Running
</a>
</h2><p>To run with TPU change <code>backend</code> to “xla-tpu” and <code>nproc_per_node</code> to 1 or 8.</p>
<div class="highlight"><pre class="shiki one-dark-pro" style="background-color: #282c34"><code><span class="line"><span style="color: #C678DD">def</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">run</span><span style="color: #ABB2BF">():</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD; font-style: italic">with</span><span style="color: #ABB2BF"> idist.</span><span style="color: #61AFEF">Parallel</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75; font-style: italic">backend</span><span style="color: #56B6C2">=</span><span style="color: #D19A66">None</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75; font-style: italic">nproc_per_node</span><span style="color: #56B6C2">=</span><span style="color: #D19A66">None</span><span style="color: #ABB2BF">) </span><span style="color: #C678DD; font-style: italic">as</span><span style="color: #ABB2BF"> parallel:</span></span>
<span class="line"><span style="color: #ABB2BF">        parallel.</span><span style="color: #61AFEF">run</span><span style="color: #ABB2BF">(training)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD; font-style: italic">if</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">__name__</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">==</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">'__main__'</span><span style="color: #ABB2BF">:</span></span>
<span class="line"><span style="color: #ABB2BF">  </span><span style="color: #61AFEF">run</span><span style="color: #ABB2BF">()</span></span>
<span class="line"></span></code></pre><button class="absolute top-1 right-1 copyBtn">
      <svg id="copyIt" class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" width="32" height="32" preserveAspectRatio="xMidYMid meet" viewBox="0 0 32 32"><path d="M28 10v18H10V10h18m0-2H10a2 2 0 0 0-2 2v18a2 2 0 0 0 2 2h18a2 2 0 0 0 2-2V10a2 2 0 0 0-2-2z" fill="#fff"></path><path d="M4 18H2V4a2 2 0 0 1 2-2h14v2H4z" fill="#fff"></path></svg>
      <svg id="copyDone" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="#0f0">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      </button></div><pre><code>2021-10-21 13:46:21,877 ignite.distributed.launcher.Parallel INFO: - Run '&lt;function training at 0x7f1fbee15710&gt;' in 1 processes
2021-10-21 13:46:21,918 NMT INFO: Train on CIFAR10
2021-10-21 13:46:21,920 NMT INFO: - PyTorch version: 1.9.0+cu111
2021-10-21 13:46:21,922 NMT INFO: - Ignite version: 0.5.0
2021-10-21 13:46:21,925 NMT INFO: - GPU Device: Tesla K80
2021-10-21 13:46:21,926 NMT INFO: - CUDA version: 11.1
2021-10-21 13:46:21,931 NMT INFO: - CUDNN version: 8005
2021-10-21 13:46:21,933 NMT INFO: 

2021-10-21 13:46:21,936 NMT INFO: Configuration:
2021-10-21 13:46:21,938 NMT INFO: 	seed: 216
2021-10-21 13:46:21,940 NMT INFO: 	with_amp: False
2021-10-21 13:46:21,943 NMT INFO: 	num_epochs: 1
2021-10-21 13:46:21,946 NMT INFO: 	batch_size: 32
2021-10-21 13:46:21,949 NMT INFO: 	output_path_: /content
2021-10-21 13:46:21,952 NMT INFO: 	model_name: t5-small
2021-10-21 13:46:21,956 NMT INFO: 	tokenizer_name: t5-small
2021-10-21 13:46:21,959 NMT INFO: 	freeze_encoder: False
2021-10-21 13:46:21,961 NMT INFO: 	num_workers: 4
2021-10-21 13:46:21,964 NMT INFO: 	weight_decay: 0.01
2021-10-21 13:46:21,968 NMT INFO: 	learning_rate: 0.0001
2021-10-21 13:46:21,972 NMT INFO: 	accumulation_steps: 1
2021-10-21 13:46:21,974 NMT INFO: 	epoch_length: 500
2021-10-21 13:46:21,976 NMT INFO: 	print_output_every: 50
2021-10-21 13:46:21,980 NMT INFO: 

2021-10-21 13:46:21,983 ignite.distributed.auto.auto_dataloader INFO: Use data loader kwargs for dataset '&lt;__main__.Transforme': 
	{'batch_size': 32, 'num_workers': 4, 'shuffle': True, 'drop_last': True, 'pin_memory': True}
2021-10-21 13:46:21,986 ignite.distributed.auto.auto_dataloader INFO: Use data loader kwargs for dataset '&lt;__main__.Transforme': 
	{'batch_size': 64, 'num_workers': 4, 'shuffle': False, 'pin_memory': True}
2021-10-21 13:46:26,245 NMT INFO: Output path: /content/Translation_Model_backend-None-1_20211021-134626
2021-10-21 13:46:26,327 NMT INFO: Engine run starting with max_epochs=1.
2021-10-21 13:46:28,533 NMT INFO: 
Epoch 0 - Evaluation time (seconds): 2.10 - Validation metrics:
    bleu: 0.10135051023993102
	bleu_smooth_2: 0.10169442246586281



100%|##########| 1/1 [00:00&lt;?, ?it/s]



[1/500]   0%|           [00:00&lt;?]


2021-10-21 13:52:00,975 NMT INFO: 
Epoch 1 - Evaluation time (seconds): 2.03 - Validation metrics:
    bleu: 0.10242125441879026
	bleu_smooth_2: 0.10276058920188186
2021-10-21 13:52:00,978 NMT INFO: Epoch[1] Complete. Time taken: 00:05:32
2021-10-21 13:52:03,141 NMT INFO: 
Epoch 1 - Evaluation time (seconds): 2.04 - Validation metrics:
    bleu: 0.10242125441879026
	bleu_smooth_2: 0.10276058920188186
2021-10-21 13:52:03,143 NMT INFO: Engine run complete. Time taken: 00:05:37
2021-10-21 13:52:03,267 ignite.distributed.launcher.Parallel INFO: End of run
</code></pre>
<div class="pb-2">
<span class="mx-2 inline-block">
<a href="/tags/machine-translation/">
#Machine Translation
</a>
</span>
<span class="mx-2 inline-block">
<a href="/tags/t5/">
#T5
</a>
</span>
<span class="mx-2 inline-block">
<a href="/tags/nlp/">
#NLP
</a>
</span>
<span class="mx-2 inline-block">
<a href="/tags/transformers/">
#Transformers
</a>
</span>
<span class="mx-2 inline-block">
<a href="/tags/bleu-score/">
#Bleu Score
</a>
</span>
<span class="mx-2 inline-block">
<a href="/tags/seq2seq-models/">
#seq2seq models
</a>
</span>
</div>
<div class="border-t grid py-6 gap-x-4 grid-cols-2 dark:border-dark-200">
<div>
<a href="/tutorials/advanced/01-collective-communication/" class="group"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 mr-1 transition-transform w-5 duration-300 inline-block group-hover:transform group-hover:-translate-x-1" viewBox="0 0 20 20" fill="currentcolor"><path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414.0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path></svg>
<span class="overflow-hidden"></span>Collective Communication with Ignite
</a>
</div>
<div>
<a href="/tutorials/beginner/02-transformers-text-classification/" class="group float-right">
<span class="overflow-hidden">Transformers for Text Classification with IMDb Reviews</span><svg xmlns="http://www.w3.org/2000/svg" class="h-5 ml-1 transition-transform w-5 duration-300 inline-block group-hover:transform group-hover:translate-x-1" viewBox="0 0 20 20" fill="currentcolor"><path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414.0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
</a>
</div>
</div>
</div>
</main>
<aside class="h-$aside-height top-$header-height py-3 px-6 sticky overflow-y-auto <lg:hidden">
<div class="py-3 px-2">
<h5 class="font-semibold">Table of Contents</h5>
<div class="text-sm py-1 px-2"><nav id="TableOfContents">
<ul>
<li><a href="#required-dependencies">Required Dependencies</a>
<ul>
<li><a href="#for-tpus">For TPUs</a></li>
</ul>
</li>
<li><a href="#common-configuration">Common Configuration</a></li>
<li><a href="#basic-setup">Basic Setup</a>
<ul>
<li><a href="#imports">Imports</a></li>
<li><a href="#preparing-data">Preparing data</a></li>
<li><a href="#tokenizer">Tokenizer</a></li>
</ul>
</li>
<li><a href="#dataset-class">Dataset Class</a></li>
<li><a href="#trainer">Trainer</a>
<ul>
<li></li>
</ul>
</li>
<li><a href="#evaluator">Evaluator</a></li>
<li><a href="#initializing-functions">Initializing Functions</a></li>
<li><a href="#logging-handlers">Logging Handlers</a></li>
<li><a href="#begin-training">Begin Training</a></li>
<li><a href="#running">Running</a></li>
</ul>
</nav></div>
</div>
</aside>
</div>
<script src="/_hugo/js/app.319fb8141aac723ecc1c6db29dd5a576.min.js" defer=""></script>
<script src="https://cdn.jsdelivr.net/npm/@docsearch/js@3"></script>
<script>fetch('https://api.github.com/repos/pytorch/ignite/releases/latest').then(a=>a.json()).then(a=>{docsearch({container:'#docsearch',appId:'7EWYE1JCT3',apiKey:'841e93e60c16975ba1bd8c7c716eed82',indexName:'pytorch-ignite',searchParameters:{facetFilters:[[`version:${a.tag_name}`,'tags:Website']]}})})</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-NQNJSZEFB4"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-NQNJSZEFB4',{anonymize_ip:!1})}</script>

</body></html>